<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFTT Data Explorer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèì</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-hover: #222230;
            --accent-primary: #6366f1;
            --accent-secondary: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #2d2d3a;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --gradient-1: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
            --gradient-2: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background Pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(14, 165, 233, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
        }


        /* Navigation */
        nav {
            display: flex;
            gap: 0.5rem;
        }

        /* Main Content */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Section */
        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.clubs { background: rgba(99, 102, 241, 0.2); }
        .stat-icon.members { background: rgba(16, 185, 129, 0.2); }
        .stat-icon.players { background: rgba(245, 158, 11, 0.2); }

        .stat-info h3 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-info p {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Search */
        .search-container {
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem 1rem;
            padding-left: 2.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        select.search-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2.5rem;
            cursor: pointer;
        }

        .search-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 400px;
        }

        .search-wrapper::before {
            content: 'üîç';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
        }

        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
        }

        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .card-badge {
            padding: 0.25rem 0.6rem;
            background: var(--accent-primary);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.running {
            background: var(--accent);
            animation: pulse 1.5s infinite;
        }

        .status-dot.success {
            background: var(--success);
        }

        .status-dot.failed {
            background: var(--danger);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .card-subtitle {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .card-stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .card-stat {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Detail Panel */
        .detail-panel {
            position: fixed;
            top: 0;
            right: -600px;
            width: 600px;
            max-width: 100vw;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            z-index: 200;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .detail-panel.open {
            right: 0;
        }

        .detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 199;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .detail-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .detail-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .detail-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .detail-content {
            padding: 1.5rem;
        }

        /* JSON Viewer */
        .json-viewer {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            overflow-x: auto;
            max-height: 60vh;
            overflow-y: auto;
        }

        .json-key { color: #818cf8; }
        .json-string { color: #10b981; }
        .json-number { color: #f59e0b; }
        .json-boolean { color: #ef4444; }
        .json-null { color: #64748b; }

        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
        }

        .info-label {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .info-value.positive { color: var(--success); }
        .info-value.negative { color: var(--error); }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--bg-card);
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .data-table tr:hover td {
            background: var(--bg-hover);
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 2rem;
        }

        .file-upload:hover {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .file-upload input {
            display: none;
        }

        .file-upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .file-upload h3 {
            margin-bottom: 0.5rem;
        }

        .file-upload p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            nav {
                flex-wrap: wrap;
                justify-content: center;
            }

            .detail-panel {
                width: 100vw;
                right: -100vw;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 
           SHADCN UI REPLICA (Pure CSS Fallback)
           Replique le style des boutons Shadcn sans d√©pendre de Tailwind CDN.
           Cela garantit que le style fonctionne m√™me si le CDN est bloqu√© ou √©choue.
        */
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            height: 2.5rem; /* h-10 */
            padding-left: 1rem;
            padding-right: 1rem;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
            outline: none;
            text-decoration: none;
            font-family: inherit;
        }
        
        .btn:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        .btn:disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        /* Variants */
        .btn-primary {
            background-color: var(--accent-primary);
            color: #ffffff;
            border: none;
        }
        .btn-primary:hover {
            opacity: 0.9;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); /* Shadow accent */
        }

        .btn-secondary {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover {
            background-color: var(--bg-hover);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--text-primary);
            border: 1px solid var(--bg-card); /* Input border color */
        }
        .btn-outline:hover {
            background-color: var(--bg-hover); /* accent */
            color: var(--text-primary);
            border-color: var(--accent-primary);
        }

        .btn-ghost {
            background-color: transparent;
            color: var(--text-muted);
            border: none;
        }
        .btn-ghost:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .btn-destructive {
            background-color: var(--error);
            color: #ffffff;
            border: none;
        }
        .btn-destructive:hover {
            opacity: 0.9;
        }

        /* Sizes */
        .btn-sm {
            height: 2.25rem; /* h-9 */
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
        }
        
        .btn-lg {
            height: 2.75rem; /* h-11 */
            padding-left: 2rem;
            padding-right: 2rem;
            border-radius: 0.5rem;
        }
        
        .btn-icon {
            height: 2.5rem;
            width: 2.5rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mapping des anciennes classes */
        .nav-btn {
            /* Inherits btn-ghost styles manually to ensure fallback works */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            height: 2.5rem;
            padding: 0.6rem 1.2rem;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent; /* Changed from border var(--border) to match ghost */
            outline: none;
            background-color: transparent;
            color: var(--text-secondary); /* muted foreground */
            font-family: inherit;
        }
        
        .nav-btn:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .nav-btn.active {
            background-color: var(--bg-hover); /* accent */
            color: var(--text-primary); /* accent foreground */
            border-bottom: 2px solid var(--accent-primary);
            border-radius: 0.375rem 0.375rem 0 0;
        }

        .close-btn {
            /* btn-ghost + btn-icon */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            height: 2.25rem;
            width: 2.25rem;
            background-color: transparent;
            border: 1px solid var(--border); /* Keep border for close btn */
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .close-btn:hover {
            background-color: var(--error);
            border-color: var(--error);
            color: white;
        }
    </style>
    <!-- Tailwind CDN removed (was causing production issues) -->
</head>
<body>
    <header>
        <div class="header-content">
            <div>
                <h1 style="font-size: 1.5rem; font-weight: 700; background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">AFTT Data Explorer</h1>
            </div>
            <nav>
                <button class="nav-btn active" data-section="clubs">Clubs</button>
                <button class="nav-btn" data-section="players">Joueurs</button>
                <button class="nav-btn" data-section="tournaments">üèÜ Tournois</button>
                <button class="nav-btn" data-section="interclubs">üèÖ Interclubs</button>
                <button class="nav-btn" data-section="admin">‚öôÔ∏è Admin</button>
                <a href="api-docs.html" class="nav-btn" style="text-decoration: none; display: inline-block;">üìö API Docs</a>
            </nav>
        </div>
    </header>

    <main>
        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-icon clubs">üè¢</div>
                <div class="stat-info">
                    <h3 id="stat-clubs">0</h3>
                    <p>Clubs</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon players">üë•</div>
                <div class="stat-info">
                    <h3 id="stat-players">0</h3>
                    <p>Joueurs inscrits</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon members">üéØ</div>
                <div class="stat-info">
                    <h3 id="stat-members">0</h3>
                    <p>Joueurs actifs</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(217, 70, 239, 0.2);">üèÜ</div>
                <div class="stat-info">
                    <h3 id="stat-tournaments">0</h3>
                    <p>Tournois</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(14, 165, 233, 0.2);">üèÖ</div>
                <div class="stat-info">
                    <h3 id="stat-interclubs">0</h3>
                    <p>Equipes interclubs</p>
                </div>
            </div>
        </div>

        <!-- Clubs Section -->
        <section id="clubs-section" class="section active">
            <div id="clubs-header" style="margin-bottom: 1.5rem;">
                <div id="regions-view-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 600;">R√©gions</h2>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button onclick="scrapeEverything()" class="btn btn-primary shadow-lg shadow-primary/20 hover:shadow-primary/40 transition-all" style="display: flex; align-items: center; gap: 0.5rem;">
                            üöÄ Scraper TOUT
                        </button>
                        <select id="region-select" class="search-input" style="padding: 0.5rem 1rem; cursor: pointer; min-width: 200px;">
                            <option value="">Toutes les r√©gions</option>
                        </select>
                    </div>
                </div>
                <div id="clubs-view-header" style="display: none; flex-direction: column; gap: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <h2 style="font-size: 1.5rem; font-weight: 600;" id="clubs-view-title">Clubs</h2>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button id="refresh-clubs-names-btn" class="nav-btn" style="text-decoration: none; display: inline-block;" title="Corrige les noms N/A">üîß Corriger noms</button>
                            <button id="reload-clubs-btn" class="nav-btn" style="text-decoration: none; display: inline-block;">üîÑ Recharger</button>
                            <button id="back-to-regions-btn" class="nav-btn" style="text-decoration: none; display: inline-block;">‚Üê Retour aux r√©gions</button>
                        </div>
                    </div>
                    <div class="search-wrapper" style="max-width: 400px;">
                        <input type="text" class="search-input" id="clubs-search" placeholder="Rechercher un club...">
                    </div>
                </div>
            </div>
            <div class="data-grid" id="clubs-grid"></div>
        </section>

        <!-- Players Section -->
        <section id="players-section" class="section">
            <div class="search-container">
                <div class="search-wrapper">
                    <input type="text" class="search-input" id="players-search" placeholder="Rechercher un joueur...">
                </div>
            </div>
            <div class="data-grid" id="players-grid"></div>
        </section>

        <!-- Tournaments Section -->
        <section id="tournaments-section" class="section">
            <div id="tournaments-header" style="margin-bottom: 1.5rem;">
                <div id="tournaments-list-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 600;">üèÜ Tournois</h2>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        <button onclick="scrapeTournaments()" class="btn btn-primary" id="scrape-tournaments-btn">
                            üîÑ Scraper les tournois
                        </button>
                        <select id="tournament-level-select" class="search-input" style="padding: 0.5rem 1rem; cursor: pointer; min-width: 180px;">
                            <option value="">Tous les niveaux</option>
                        </select>
                        <div class="search-wrapper" style="max-width: 300px;">
                            <input type="text" class="search-input" id="tournaments-search" placeholder="Rechercher un tournoi...">
                        </div>
                    </div>
                </div>
                <div id="tournament-detail-header" style="display: none; flex-direction: column; gap: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <h2 style="font-size: 1.5rem; font-weight: 600;" id="tournament-detail-title">Tournoi</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button id="rescrape-tournament-btn" class="btn btn-primary" style="display: inline-block;">üîÑ Rescraper ce tournoi</button>
                            <button id="back-to-tournaments-btn" class="nav-btn" style="text-decoration: none; display: inline-block;">‚Üê Retour aux tournois</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="tournaments-scrape-status" style="display: none; background: var(--bg-card); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <!-- Statut du scraping des tournois -->
            </div>
            <div class="data-grid" id="tournaments-grid"></div>
        </section>

        <!-- Interclubs Section -->
        <section id="interclubs-section" class="section">
            <div id="interclubs-header" style="margin-bottom: 1.5rem;">
                <div id="interclubs-main-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 600;">üèÖ Classements Interclubs</h2>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        <button onclick="scrapeInterclubs()" class="btn btn-primary" id="scrape-interclubs-btn">
                            üîÑ Scraper les interclubs
                        </button>
                        <div class="search-wrapper" style="max-width: 300px;">
                            <input type="text" class="search-input" id="interclubs-team-search" placeholder="Rechercher une equipe...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scrape status -->
            <div id="interclubs-scrape-status" style="display: none; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600;">üîÑ Scraping en cours...</span>
                    <button onclick="cancelInterclubsScrape()" class="btn btn-outline" style="padding: 0.25rem 0.75rem; font-size: 0.75rem; border: 1px solid var(--error); color: var(--error);">Annuler</button>
                </div>
                <div id="interclubs-scrape-info" style="color: var(--text-muted); font-size: 0.85rem;"></div>
            </div>

            <!-- Filtres division + semaine -->
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: end;">
                <div style="flex: 1; min-width: 250px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.3rem;">Division</label>
                    <select id="interclubs-division-select" class="search-input" style="padding: 0.6rem 1rem; cursor: pointer; width: 100%; max-width: 100%; padding-left: 1rem;">
                        <option value="">-- Choisir une division --</option>
                    </select>
                </div>
                <div style="min-width: 120px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.3rem;">Semaine</label>
                    <select id="interclubs-week-select" class="search-input" style="padding: 0.6rem 1rem; cursor: pointer; width: 100%; padding-left: 1rem;">
                        <option value="">Sem.</option>
                    </select>
                </div>
                <div style="min-width: 160px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.3rem;">Categorie</label>
                    <select id="interclubs-category-filter" class="search-input" style="padding: 0.6rem 1rem; cursor: pointer; width: 100%; padding-left: 1rem;">
                        <option value="">Toutes</option>
                    </select>
                </div>
                <button onclick="loadInterclubsRanking()" class="btn btn-primary" style="height: 42px;">
                    Afficher
                </button>
            </div>

            <!-- Tableau de classement -->
            <div id="interclubs-ranking-container" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                <div id="interclubs-ranking-title" style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: none;">
                    <h3 style="font-size: 1.1rem; font-weight: 600;" id="interclubs-ranking-title-text"></h3>
                </div>
                <div id="interclubs-ranking-content" style="padding: 1.5rem;">
                    <p style="color: var(--text-muted); text-align: center;">Selectionnez une division et une semaine pour afficher le classement</p>
                </div>
            </div>

            <!-- Recherche equipes resultats -->
            <div id="interclubs-search-results" style="display: none; margin-top: 1.5rem;">
                <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;">Resultats de recherche</h3>
                <div class="data-grid" id="interclubs-search-grid"></div>
            </div>
        </section>

        <!-- Admin Section -->
        <section id="admin-section" class="section">
            <div style="margin-bottom: 2rem;">
                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">‚öôÔ∏è Administration - Scraping</h2>
                
                <!-- T√¢che en cours -->
                <div id="admin-current-task" style="background: var(--bg-card); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="font-size: 1.1rem;">T√¢che en cours</h3>
                        <button onclick="startFullScrape()" class="btn btn-primary" id="start-scrape-btn">
                            üöÄ Lancer scraping complet
                        </button>
                    </div>
                    <div id="current-task-content">
                        <p style="color: var(--text-muted);">Aucun scraping en cours</p>
                    </div>
                    
                    <!-- Terminal de logs -->
                    <div id="scrape-terminal-container" style="display: none; margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h4 style="font-size: 0.9rem; color: var(--text-secondary);">üì∫ Terminal</h4>
                            <button onclick="toggleTerminal()" class="btn btn-outline" style="padding: 0.25rem 0.75rem; font-size: 0.75rem;">
                                <span id="terminal-toggle-text">‚ñº R√©duire</span>
                            </button>
                        </div>
                        <div id="scrape-terminal" style="background: #0d1117; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; font-family: 'JetBrains Mono', 'Consolas', monospace; font-size: 0.85rem; max-height: 600px; min-height: 300px; overflow-y: auto; color: #e6edf3;">
                            <div style="color: var(--text-muted);">üñ•Ô∏è En attente du scraping... Le terminal affichera les donn√©es r√©cup√©r√©es en temps r√©el.</div>
                        </div>
                    </div>
                </div>
                
                <!-- Historique -->
                <div style="background: var(--bg-card); border-radius: 12px; padding: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="font-size: 1.1rem;">Historique des t√¢ches</h3>
                        <button onclick="loadScrapeHistory()" class="btn btn-outline hover:bg-primary/10">üîÑ Rafra√Æchir</button>
                    </div>
                    <div id="scrape-history">
                        <p style="color: var(--text-muted);">Chargement...</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Detail Panel -->
    <div class="detail-overlay" id="detail-overlay"></div>
    <div class="detail-panel" id="detail-panel">
        <div class="detail-header">
            <h2 class="detail-title" id="detail-title">D√©tails</h2>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <button class="close-btn" id="rescrape-btn" title="Rescraper ce joueur" style="display: none; font-size: 1.2rem; cursor: pointer;">üîÑ</button>
                <button class="close-btn" id="close-detail">√ó</button>
            </div>
        </div>
        <div class="detail-content" id="detail-content"></div>
    </div>

    <script>
        // API Base URL - D√©tecter automatiquement (fonctionne en local et en production)
        const API_BASE_URL = window.location.origin;
        
        // State
        const state = {
            clubs: [],
            members: {},
            players: {},
            provinces: [],
            selectedProvince: '',
            currentSection: 'clubs',
            viewMode: 'regions' // 'regions' ou 'clubs'
        };

        // DOM Elements
        const sections = document.querySelectorAll('.section');
        const navBtns = document.querySelectorAll('.nav-btn');
        const detailPanel = document.getElementById('detail-panel');
        const detailOverlay = document.getElementById('detail-overlay');
        const detailTitle = document.getElementById('detail-title');
        const detailContent = document.getElementById('detail-content');
        const rescrapeBtn = document.getElementById('rescrape-btn');

        // Navigation
        navBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const section = btn.dataset.section;
                
                // Si c'est un lien (comme API Docs), ne pas g√©rer la navigation
                if (!section) {
                    return;
                }
                
                const targetSection = document.getElementById(`${section}-section`);
                if (!targetSection) {
                    console.error(`Section ${section}-section introuvable`);
                    return;
                }
                
                navBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                sections.forEach(s => s.classList.remove('active'));
                targetSection.classList.add('active');
                state.currentSection = section;
                
                // Charger les donn√©es admin si n√©cessaire
                if (section === 'admin') {
                    loadScrapeStatus();
                    loadScrapeHistory();
                }
                // Charger les divisions interclubs
                if (section === 'interclubs') {
                    loadInterclubsDivisions();
                    checkInterclubsScrapeStatus();
                }
            });
        });

        // Detail Panel
        let currentDetailLicence = null;

        function openDetail(title, content) {
            detailTitle.textContent = title;
            detailContent.innerHTML = content;
            rescrapeBtn.style.display = 'none';
            currentDetailLicence = null;
            detailPanel.classList.add('open');
            detailOverlay.classList.add('open');
        }

        function openPlayerDetail(title, content, licence) {
            detailTitle.textContent = title;
            detailContent.innerHTML = content;
            currentDetailLicence = licence;
            rescrapeBtn.style.display = 'inline-flex';
            detailPanel.classList.add('open');
            detailOverlay.classList.add('open');
        }

        function closeDetail() {
            detailPanel.classList.remove('open');
            detailOverlay.classList.remove('open');
            currentDetailLicence = null;
            rescrapeBtn.style.display = 'none';
        }

        document.getElementById('close-detail').addEventListener('click', closeDetail);
        detailOverlay.addEventListener('click', closeDetail);

        // Rescrape un joueur
        rescrapeBtn.addEventListener('click', async () => {
            if (!currentDetailLicence) return;
            const licence = currentDetailLicence;
            rescrapeBtn.disabled = true;
            rescrapeBtn.textContent = '‚è≥';
            try {
                const res = await fetch(`${API_BASE_URL}/api/players/${licence}/scrape`, { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();
                    // Mettre √† jour le state avec les nouvelles donn√©es
                    state.players[licence] = data.player;
                    // R√©ouvrir le d√©tail avec les donn√©es fra√Æches
                    await showPlayerDetail(licence);
                } else {
                    const err = await res.json();
                    alert(`Erreur: ${err.detail || '√âchec du scraping'}`);
                }
            } catch (e) {
                console.error('Erreur rescrape:', e);
                alert('Erreur lors du rescraping. V√©rifiez que l\'API est d√©marr√©e.');
            } finally {
                rescrapeBtn.disabled = false;
                rescrapeBtn.textContent = 'üîÑ';
            }
        });

        // JSON Syntax Highlighting
        function syntaxHighlight(json) {
            if (typeof json !== 'string') {
                json = JSON.stringify(json, null, 2);
            }
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // Update Stats
        async function updateStats() {
            try {
                const statsRes = await fetch(`${API_BASE_URL}/api/stats`);
                if (statsRes.ok) {
                    const stats = await statsRes.json();
                    // Clubs : nombre total dans la DB
                    document.getElementById('stat-clubs').textContent = stats.clubs || state.clubs.length;
                    // Joueurs : nombre total dans la DB
                    document.getElementById('stat-players').textContent = (stats.players || 0).toLocaleString();
                    // Membres : joueurs avec des fiches/matchs
                    document.getElementById('stat-members').textContent = (stats.players_with_matches || 0).toLocaleString();
                } else {
                    // Fallback : utiliser les donn√©es locales
                    document.getElementById('stat-clubs').textContent = state.clubs.length;
                    document.getElementById('stat-players').textContent = Object.keys(state.players).length;
                    document.getElementById('stat-members').textContent = Object.keys(state.players).length;
                }
                
                // Tournois : r√©cup√©rer le nombre depuis l'API
                try {
                    const tournamentsRes = await fetch(`${API_BASE_URL}/api/tournaments?limit=1`);
                    if (tournamentsRes.ok) {
                        const data = await tournamentsRes.json();
                        // L'API retourne {count: N, tournaments: [...]}
                        // Mais count est le nombre retourn√©, pas le total. On doit faire une requ√™te sans limit
                        const allTournamentsRes = await fetch(`${API_BASE_URL}/api/tournaments`);
                        if (allTournamentsRes.ok) {
                            const allData = await allTournamentsRes.json();
                            document.getElementById('stat-tournaments').textContent = allData.count || 0;
                        }
                    }
                } catch (e) {
                    document.getElementById('stat-tournaments').textContent = '0';
                }

                // Interclubs : nombre d'equipes
                try {
                    const icRes = await fetch(`${API_BASE_URL}/api/interclubs/stats`);
                    if (icRes.ok) {
                        const icData = await icRes.json();
                        document.getElementById('stat-interclubs').textContent = (icData.teams_count || 0).toLocaleString();
                    }
                } catch (e) {
                    document.getElementById('stat-interclubs').textContent = '0';
                }
            } catch (e) {
                // En cas d'erreur, utiliser les donn√©es locales
                document.getElementById('stat-clubs').textContent = state.clubs.length;
                document.getElementById('stat-players').textContent = Object.keys(state.players).length;
                document.getElementById('stat-members').textContent = Object.keys(state.players).length;
                document.getElementById('stat-tournaments').textContent = '0';
                document.getElementById('stat-interclubs').textContent = '0';
            }
        }

        // Render Regions
        function renderRegions() {
            const grid = document.getElementById('clubs-grid');
            
            if (!grid) {
                console.error('√âl√©ment clubs-grid introuvable');
                return;
            }
            
            // V√©rifier que les clubs sont charg√©s
            if (!state.clubs || state.clubs.length === 0) {
                grid.innerHTML = `<p style="grid-column: 1/-1; color: var(--text-muted); text-align: center; padding: 3rem;">
                    Chargement des r√©gions...
                </p>`;
                return;
            }
            
            // Calculer le nombre de clubs par province
            // Normaliser les noms de provinces pour √©viter les doublons
            const provinceCounts = {};
            state.clubs.forEach(club => {
                let province = club.province || 'Non sp√©cifi√©';
                province = province.trim();
                // Normaliser les variations de noms de provinces
                if (province.toLowerCase().includes('hainaut')) {
                    province = 'Hainaut';
                }
                provinceCounts[province] = (provinceCounts[province] || 0) + 1;
            });
            
            // Debug: v√©rifier si H004 est pr√©sent
            const h004 = state.clubs.find(c => c.code === 'H004');
            if (h004) {
                console.log('Club H004 trouv√©:', h004);
            } else {
                console.warn('Club H004 non trouv√© dans les clubs charg√©s');
            }

            // Trier les provinces par nombre de clubs (d√©croissant)
            const sortedProvinces = Object.entries(provinceCounts)
                .sort((a, b) => b[1] - a[1]);

            if (sortedProvinces.length === 0) {
                grid.innerHTML = `<p style="grid-column: 1/-1; color: var(--text-muted); text-align: center; padding: 3rem;">
                    Aucune r√©gion disponible
                </p>`;
                return;
            }

            grid.innerHTML = sortedProvinces.map(([province, count]) => `
                <div class="card" onclick="showProvinceClubs('${province.replace(/'/g, "\\'")}')" style="cursor: pointer;">
                    <div class="card-header">
                        <span class="card-title">${province}</span>
                    </div>
                    <div class="card-subtitle">${count} ${count === 1 ? 'club' : 'clubs'}</div>
                    <div class="card-stats">
                        <div class="card-stat">üìç ${province}</div>
                    </div>
                    <button class="btn btn-outline hover:bg-primary/20 hover:text-primary hover:border-primary transition-all" onclick="event.stopPropagation(); scrapeProvince('${province.replace(/'/g, "\\'")}')" style="margin-top: 1rem; width: 100%; font-size: 0.85rem;">
                        üîÑ Scraper tout
                    </button>
                </div>
            `).join('');
        }

        // Scrape all clubs from a province (avec progression en temps r√©el)
        async function scrapeProvince(province) {
            if (!confirm(`Lancer le scraping complet de tous les clubs de ${province} ?\\n\\nCela peut prendre plusieurs minutes.`)) {
                return;
            }
            
            const grid = document.getElementById('clubs-grid');
            
            // 1. R√©cup√©rer la liste des clubs de cette province
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                    <div style="font-size: 2rem;">üîç</div>
                    <p>R√©cup√©ration de la liste des clubs...</p>
                </div>
            `;
            
            let clubsToScrape = [];
            try {
                const res = await fetch(`${API_BASE_URL}/api/clubs?province=${encodeURIComponent(province)}`);
                if (res.ok) {
                    const data = await res.json();
                    clubsToScrape = data.clubs || [];
                }
            } catch (e) {
                showToast(`‚ùå Erreur: ${e.message}`, 'error');
                renderRegions();
                return;
            }
            
            if (clubsToScrape.length === 0) {
                showToast(`Aucun club trouv√© pour ${province}`, 'error');
                renderRegions();
                return;
            }
            
            // 2. Scraper chaque club avec progression
            let completed = 0;
            let totalPlayers = 0;
            let errors = [];
            
            const updateProgress = (currentClub, status) => {
                const percent = Math.round((completed / clubsToScrape.length) * 100);
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                        <h3 style="margin-bottom: 1rem;">üîÑ Scraping ${province}</h3>
                        
                        <div style="background: var(--bg-tertiary); border-radius: 8px; height: 24px; width: 100%; max-width: 400px; margin: 0 auto 1rem; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, var(--accent), var(--accent-light)); height: 100%; width: ${percent}%; transition: width 0.3s; display: flex; align-items: center; justify-content: center;">
                                <span style="color: white; font-weight: bold; font-size: 0.8rem;">${percent}%</span>
                            </div>
                        </div>
                        
                        <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">
                            <strong>${completed}</strong> / ${clubsToScrape.length} clubs
                        </p>
                        
                        <p style="color: var(--text-muted); margin-bottom: 1rem;">
                            ${totalPlayers} joueurs r√©cup√©r√©s
                        </p>
                        
                        <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; max-width: 400px; margin: 0 auto;">
                            <p style="color: var(--accent-light); font-weight: 500;">
                                ${status === 'loading' ? '‚è≥' : status === 'success' ? '‚úÖ' : '‚ùå'} 
                                ${currentClub.code} - ${currentClub.name}
                            </p>
                        </div>
                        
                        ${errors.length > 0 ? `
                            <p style="color: var(--danger); margin-top: 1rem; font-size: 0.9rem;">
                                ‚ö†Ô∏è ${errors.length} erreur(s)
                            </p>
                        ` : ''}
                        
                        <button class="btn btn-secondary" onclick="window.scrapingCancelled = true" style="margin-top: 1.5rem;">
                            ‚èπÔ∏è Arr√™ter
                        </button>
                    </div>
                `;
            };
            
            window.scrapingCancelled = false;
            
            for (const club of clubsToScrape) {
                if (window.scrapingCancelled) {
                    showToast('Scraping annul√©', 'info');
                    break;
                }
                
                updateProgress(club, 'loading');
                
                try {
                    const res = await fetch(`${API_BASE_URL}/api/clubs/${club.code}/scrape`, {
                        method: 'POST'
                    });
                    
                    if (res.ok) {
                        const result = await res.json();
                        totalPlayers += result.players_scraped || 0;
                        updateProgress(club, 'success');
                    } else {
                        errors.push({ club: club.code, error: `HTTP ${res.status}` });
                        updateProgress(club, 'error');
                    }
                } catch (e) {
                    errors.push({ club: club.code, error: e.message });
                    updateProgress(club, 'error');
                }
                
                completed++;
                
                // Petite pause pour ne pas surcharger
                await new Promise(r => setTimeout(r, 100));
            }
            
            // 3. Afficher le r√©sum√© final
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">${errors.length === 0 ? 'üéâ' : '‚ö†Ô∏è'}</div>
                    <h3>Scraping termin√© !</h3>
                    <p style="font-size: 1.2rem; margin: 1rem 0;">
                        <strong>${completed}</strong> clubs ‚Ä¢ <strong>${totalPlayers}</strong> joueurs
                    </p>
                    ${errors.length > 0 ? `
                        <p style="color: var(--danger);">${errors.length} erreur(s)</p>
                        <details style="margin-top: 1rem; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;">
                            <summary style="cursor: pointer; color: var(--text-muted);">Voir les erreurs</summary>
                            <ul style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--danger);">
                                ${errors.map(e => `<li>${e.club}: ${e.error}</li>`).join('')}
                            </ul>
                        </details>
                    ` : ''}
                    <button class="btn btn-primary" onclick="loadClubsForProvince(''); renderRegions();" style="margin-top: 1.5rem;">
                        ‚Üê Retour aux r√©gions
                    </button>
                </div>
            `;
            
            showToast(`‚úÖ ${province}: ${completed} clubs, ${totalPlayers} joueurs`, 'success');
        }

        // Scrape EVERYTHING - toutes les r√©gions, tous les clubs, tous les joueurs
        async function scrapeEverything() {
            if (!confirm('üöÄ Scraper TOUT ?\n\nCela va r√©cup√©rer TOUS les clubs et TOUS les joueurs de TOUTES les r√©gions.\n\n‚ö†Ô∏è Cette op√©ration peut prendre 30+ minutes.')) {
                return;
            }
            
            const grid = document.getElementById('clubs-grid');
            const startTime = Date.now();
            
            // 1. R√©cup√©rer tous les clubs
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                    <div style="font-size: 2rem;">üîç</div>
                    <p>R√©cup√©ration de la liste de tous les clubs...</p>
                </div>
            `;
            
            let allClubs = [];
            try {
                const res = await fetch(`${API_BASE_URL}/api/clubs`);
                if (res.ok) {
                    const data = await res.json();
                    allClubs = data.clubs || [];
                }
            } catch (e) {
                showToast(`‚ùå Erreur: ${e.message}`, 'error');
                renderRegions();
                return;
            }
            
            if (allClubs.length === 0) {
                showToast('Aucun club trouv√©', 'error');
                renderRegions();
                return;
            }
            
            // Organiser par province
            const clubsByProvince = {};
            allClubs.forEach(club => {
                const prov = club.province || 'Non sp√©cifi√©';
                if (!clubsByProvince[prov]) clubsByProvince[prov] = [];
                clubsByProvince[prov].push(club);
            });
            
            const provinces = Object.keys(clubsByProvince).sort();
            const totalClubs = allClubs.length;
            
            // 2. Stats globales
            let globalCompleted = 0;
            let globalPlayers = 0;
            let globalErrors = [];
            let currentProvinceIndex = 0;
            
            window.scrapingCancelled = false;
            
            const formatTime = (ms) => {
                const seconds = Math.floor(ms / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                if (hours > 0) return `${hours}h ${minutes % 60}m`;
                if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
                return `${seconds}s`;
            };
            
            const updateGlobalProgress = (currentProvince, currentClub, clubStatus) => {
                const elapsed = Date.now() - startTime;
                const avgTimePerClub = globalCompleted > 0 ? elapsed / globalCompleted : 5000;
                const remaining = (totalClubs - globalCompleted) * avgTimePerClub;
                const percentGlobal = Math.round((globalCompleted / totalClubs) * 100);
                const provinceClubs = clubsByProvince[currentProvince] || [];
                const provinceCompleted = provinceClubs.filter(c => 
                    allClubs.indexOf(c) < allClubs.indexOf(currentClub) || c === currentClub
                ).length;
                const percentProvince = provinceClubs.length > 0 ? Math.round((provinceCompleted / provinceClubs.length) * 100) : 0;
                
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; padding: 1.5rem;">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <h2 style="margin-bottom: 0.5rem;">üöÄ Scraping complet en cours</h2>
                            <p style="color: var(--text-muted);">
                                ‚è±Ô∏è ${formatTime(elapsed)} √©coul√© ‚Ä¢ ~${formatTime(remaining)} restant
                            </p>
                        </div>
                        
                        <!-- Progression globale -->
                        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <span style="font-weight: 600;">üìä Progression globale</span>
                                <span style="font-size: 1.2rem; font-weight: bold; color: var(--accent);">${percentGlobal}%</span>
                            </div>
                            <div style="background: var(--bg-tertiary); border-radius: 8px; height: 20px; overflow: hidden; margin-bottom: 0.75rem;">
                                <div style="background: linear-gradient(90deg, #10b981, #34d399); height: 100%; width: ${percentGlobal}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent);">${globalCompleted}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">/ ${totalClubs} clubs</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">${globalPlayers.toLocaleString()}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">joueurs</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: ${globalErrors.length > 0 ? 'var(--danger)' : 'var(--text-muted)'}">${globalErrors.length}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">erreurs</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- R√©gion en cours -->
                        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <span style="font-weight: 600;">üìç R√©gion: ${currentProvince}</span>
                                <span style="font-size: 0.9rem; color: var(--text-muted);">${currentProvinceIndex + 1} / ${provinces.length}</span>
                            </div>
                            <div style="background: var(--bg-tertiary); border-radius: 8px; height: 12px; overflow: hidden; margin-bottom: 0.5rem;">
                                <div style="background: linear-gradient(90deg, var(--accent), var(--accent-light)); height: 100%; width: ${percentProvince}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                ${provinceCompleted} / ${provinceClubs.length} clubs dans cette r√©gion
                            </div>
                        </div>
                        
                        <!-- Club en cours -->
                        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 1.5rem;">
                                    ${clubStatus === 'loading' ? '‚è≥' : clubStatus === 'success' ? '‚úÖ' : '‚ùå'}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--accent-light);">${currentClub.code}</div>
                                    <div style="font-size: 0.9rem; color: var(--text-muted);">${currentClub.name}</div>
                                </div>
                                <div style="text-align: right; font-size: 0.8rem; color: var(--text-muted);">
                                    ${clubStatus === 'loading' ? 'En cours...' : clubStatus === 'success' ? 'Termin√©' : 'Erreur'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Liste des r√©gions -->
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-bottom: 1.5rem;">
                            ${provinces.map((p, i) => {
                                let status = '‚¨ú';
                                let bg = 'var(--bg-tertiary)';
                                if (i < currentProvinceIndex) { status = '‚úÖ'; bg = 'rgba(16, 185, 129, 0.2)'; }
                                else if (i === currentProvinceIndex) { status = 'üîÑ'; bg = 'rgba(99, 102, 241, 0.2)'; }
                                return `<span style="background: ${bg}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${status} ${p}</span>`;
                            }).join('')}
                        </div>
                        
                        <div style="text-align: center;">
                            <button class="btn btn-secondary" onclick="window.scrapingCancelled = true" style="padding: 0.75rem 2rem;">
                                ‚èπÔ∏è Arr√™ter le scraping
                            </button>
                        </div>
                    </div>
                `;
            };
            
            // 3. Scraper province par province, club par club
            for (let pIdx = 0; pIdx < provinces.length; pIdx++) {
                if (window.scrapingCancelled) break;
                
                const province = provinces[pIdx];
                currentProvinceIndex = pIdx;
                const clubs = clubsByProvince[province];
                
                for (const club of clubs) {
                    if (window.scrapingCancelled) {
                        showToast('Scraping annul√©', 'info');
                        break;
                    }
                    
                    updateGlobalProgress(province, club, 'loading');
                    
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/clubs/${club.code}/scrape`, {
                            method: 'POST'
                        });
                        
                        if (res.ok) {
                            const result = await res.json();
                            globalPlayers += result.players_scraped || 0;
                            updateGlobalProgress(province, club, 'success');
                        } else {
                            globalErrors.push({ club: club.code, province, error: `HTTP ${res.status}` });
                            updateGlobalProgress(province, club, 'error');
                        }
                    } catch (e) {
                        globalErrors.push({ club: club.code, province, error: e.message });
                        updateGlobalProgress(province, club, 'error');
                    }
                    
                    globalCompleted++;
                    
                    // Pause entre chaque club
                    await new Promise(r => setTimeout(r, 50));
                }
            }
            
            // 4. R√©sum√© final
            const totalTime = Date.now() - startTime;
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${globalErrors.length === 0 ? 'üéâ' : '‚ö†Ô∏è'}</div>
                    <h2 style="margin-bottom: 1rem;">Scraping complet termin√© !</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; max-width: 600px; margin: 2rem auto;">
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent);">${provinces.length}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">r√©gions</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">${globalCompleted}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">clubs</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-light);">${globalPlayers.toLocaleString()}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">joueurs</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: bold;">${formatTime(totalTime)}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">dur√©e</div>
                        </div>
                    </div>
                    
                    ${globalErrors.length > 0 ? `
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 8px; padding: 1rem; max-width: 500px; margin: 1rem auto;">
                            <p style="color: var(--danger); margin-bottom: 0.5rem;">‚ö†Ô∏è ${globalErrors.length} erreur(s) rencontr√©e(s)</p>
                            <details>
                                <summary style="cursor: pointer; color: var(--text-muted); font-size: 0.85rem;">Voir le d√©tail</summary>
                                <ul style="text-align: left; margin-top: 0.5rem; font-size: 0.8rem; color: var(--danger); max-height: 200px; overflow-y: auto;">
                                    ${globalErrors.map(e => `<li>${e.club} (${e.province}): ${e.error}</li>`).join('')}
                                </ul>
                            </details>
                        </div>
                    ` : ''}
                    
                    <button class="btn btn-primary" onclick="loadClubsForProvince(''); renderRegions(); updateStats();" style="margin-top: 1.5rem; padding: 0.75rem 2rem;">
                        ‚úÖ Termin√© - Retour aux r√©gions
                    </button>
                </div>
            `;
            
            showToast(`üéâ Scraping termin√©: ${globalCompleted} clubs, ${globalPlayers.toLocaleString()} joueurs`, 'success');
        }

        // Load clubs for a province from API
        async function loadClubsForProvince(province) {
            try {
                const url = province 
                    ? `${API_BASE_URL}/api/clubs?province=${encodeURIComponent(province)}`
                    : `${API_BASE_URL}/api/clubs`;
                
                const res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    state.clubs = data.clubs || data;
                    console.log(`‚úÖ ${state.clubs.length} clubs charg√©s${province ? ` pour ${province}` : ''}`);
                    return true;
                }
            } catch (e) {
                console.error(`Erreur lors du chargement des clubs pour ${province}:`, e);
            }
            return false;
        }

        // Show clubs for a province
        async function showProvinceClubs(province) {
            state.selectedProvince = province;
            state.viewMode = 'clubs';
            
            // Afficher le header des clubs
            document.getElementById('regions-view-header').style.display = 'none';
            document.getElementById('clubs-view-header').style.display = 'flex';
            document.getElementById('clubs-view-title').textContent = `Clubs - ${province}`;
            
            // R√©initialiser la recherche
            document.getElementById('clubs-search').value = '';
            
            // Charger les clubs de cette province depuis l'API
            const grid = document.getElementById('clubs-grid');
            grid.innerHTML = `<p style="grid-column: 1/-1; color: var(--text-muted); text-align: center; padding: 3rem;">Chargement des clubs...</p>`;
            
            await loadClubsForProvince(province);
            
            // Afficher les clubs
            renderClubs('');
        }

        // Back to regions view
        async function backToRegions() {
            state.selectedProvince = '';
            state.viewMode = 'regions';
            
            // Afficher le header des r√©gions
            const regionsHeader = document.getElementById('regions-view-header');
            const clubsHeader = document.getElementById('clubs-view-header');
            
            if (regionsHeader) regionsHeader.style.display = 'flex';
            if (clubsHeader) clubsHeader.style.display = 'none';
            
            // R√©initialiser la recherche
            const searchInput = document.getElementById('clubs-search');
            if (searchInput) searchInput.value = '';
            
            // R√©initialiser le s√©lecteur de r√©gion
            const regionSelect = document.getElementById('region-select');
            if (regionSelect) regionSelect.value = '';
            
            // Recharger tous les clubs pour recalculer les r√©gions
            await loadClubsForProvince('');
            
            // Afficher les r√©gions
            renderRegions();
        }
        
        // Load provinces list
        async function loadProvincesList() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/clubs/provinces`);
                if (res.ok) {
                    const data = await res.json();
                    const provinces = data.provinces || [];
                    
                    const select = document.getElementById('region-select');
                    if (select) {
                        select.innerHTML = '<option value="">Toutes les r√©gions</option>';
                        provinces.forEach(province => {
                            const option = document.createElement('option');
                            option.value = province;
                            option.textContent = province;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (e) {
                console.error('Erreur lors du chargement des provinces:', e);
            }
        }
        
        // Refresh clubs names (fix N/A)
        async function refreshClubsNames() {
            const btn = document.getElementById('refresh-clubs-names-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Chargement...';
            btn.disabled = true;
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/scrape/refresh-clubs`, {
                    method: 'POST'
                });
                
                if (!res.ok) throw new Error('Erreur lors du rafra√Æchissement');
                
                const data = await res.json();
                showToast(`‚úÖ ${data.message}`, 'success');
                
                // Recharger les clubs pour voir les noms corrig√©s
                await loadClubsForProvince(state.selectedProvince || '');
                
                if (state.viewMode === 'clubs') {
                    renderClubs(document.getElementById('clubs-search')?.value || '');
                } else {
                    renderRegions();
                }
                
            } catch (e) {
                console.error('Erreur:', e);
                showToast('‚ùå Erreur lors du rafra√Æchissement des clubs', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // Reload clubs for selected region
        async function reloadClubsForSelectedRegion() {
            // Recharger les clubs de la r√©gion actuellement affich√©e
            if (state.selectedProvince) {
                // Afficher un message de chargement avec progression
                const grid = document.getElementById('clubs-grid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                            <h3>Scraping en cours...</h3>
                            <p style="color: var(--text-muted);">R√©cup√©ration des donn√©es pour tous les clubs de ${state.selectedProvince}</p>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 1rem;">Cela peut prendre plusieurs minutes...</p>
                        </div>
                    `;
                }
                
                try {
                    // Lancer le scraping de tous les clubs de la province
                    const scrapeRes = await fetch(`${API_BASE_URL}/api/clubs/province/${encodeURIComponent(state.selectedProvince)}/scrape`, {
                        method: 'POST'
                    });
                    
                    if (!scrapeRes.ok) {
                        throw new Error(`Erreur HTTP: ${scrapeRes.status}`);
                    }
                    
                    const scrapeData = await scrapeRes.json();
                    console.log('Scraping termin√©:', scrapeData);
                    
                    // Afficher les r√©sultats
                    if (grid) {
                        grid.innerHTML = `
                            <div style="grid-column: 1/-1; background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); border-radius: 10px; padding: 1.5rem; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.5rem;">‚úÖ</span>
                                    <strong style="color: var(--success);">Scraping termin√© avec succ√®s</strong>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.8;">
                                    <div>${scrapeData.clubs_scraped}/${scrapeData.clubs_total} clubs trait√©s</div>
                                    <div>${scrapeData.members_scraped} membres scrap√©s</div>
                                    <div>${scrapeData.players_scraped} fiches joueurs scrap√©es</div>
                                    ${scrapeData.clubs_errors?.length > 0 ? `<div style="color: var(--warning);">‚ö†Ô∏è ${scrapeData.clubs_errors.length} erreur(s) de club</div>` : ''}
                                    ${scrapeData.players_errors?.length > 0 ? `<div style="color: var(--warning);">‚ö†Ô∏è ${scrapeData.players_errors.length} erreur(s) de joueur</div>` : ''}
                                </div>
                            </div>
                        `;
                    }
                    
                    // Recharger les clubs depuis l'API pour afficher les donn√©es mises √† jour
                    await loadClubsForProvince(state.selectedProvince);
                    
                    // R√©afficher les clubs
                    const searchValue = document.getElementById('clubs-search')?.value || '';
                    renderClubs(searchValue);
                    
                    // Mettre √† jour les stats
                    await updateStats();
                    
                } catch (e) {
                    console.error(`Erreur lors du scraping de la province ${state.selectedProvince}:`, e);
                    if (grid) {
                        grid.innerHTML = `
                            <div style="grid-column: 1/-1; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); border-radius: 10px; padding: 1.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.5rem;">‚ùå</span>
                                    <strong style="color: var(--error);">Erreur lors du scraping</strong>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                    ${e.message || 'Une erreur est survenue'}
                                </div>
                            </div>
                        `;
                    }
                }
            } else {
                // Si on est sur la vue r√©gions, recharger tous les clubs
                await loadClubsForProvince('');
                renderRegions();
            }
        }

        // Render Clubs
        function renderClubs(filter = '') {
            const grid = document.getElementById('clubs-grid');
            
            // Filtrer par province s√©lectionn√©e
            let filtered = state.clubs.filter(club => club.province === state.selectedProvince);
            
            // Filtrer par recherche textuelle
            if (filter) {
                filtered = filtered.filter(club => 
                    club.name?.toLowerCase().includes(filter.toLowerCase()) ||
                    club.code?.toLowerCase().includes(filter.toLowerCase())
                );
            }

            if (filtered.length === 0) {
                grid.innerHTML = `<p style="grid-column: 1/-1; color: var(--text-muted); text-align: center; padding: 3rem;">
                    Aucun club trouv√© dans la r√©gion "${state.selectedProvince}"
                </p>`;
                return;
            }

            grid.innerHTML = filtered.map(club => `
                <div class="card" onclick="showClubDetail('${club.code}')">
                    <div class="card-header">
                        <span class="card-badge">${club.code}</span>
                        <span class="card-title">${club.name || 'N/A'}</span>
                    </div>
                    <div class="card-subtitle">${club.province || ''}</div>
                    <div class="card-stats">
                        <div class="card-stat">üìç ${club.province || 'N/A'}</div>
                    </div>
                </div>
            `).join('');
        }
        

        // Fonction de tri par classement
        // Ordre: NC < E6 < E4 < E2 < E0 < D6 < D4 < D2 < D0 < C6 < C4 < C2 < C0 < B6 < B4 < B2 < B0 < A
        // Note: Le chiffre est invers√© (6 < 4 < 2 < 0) car E6 est plus faible que E0
        function sortPlayersByRanking(players) {
            function getRankingValue(ranking) {
                if (!ranking) return -1; // Pas de classement = le plus bas
                const r = ranking.trim().toUpperCase();
                
                // NC (Non Class√©) = 0
                if (r === 'NC' || r === 'N') return 0;
                
                // Extraire la lettre et le chiffre
                const match = r.match(/^([ABCDE])(\d+)$/);
                if (!match) return 9999; // Classement inconnu = le plus haut
                
                const letter = match[1];
                const number = parseInt(match[2], 10);
                
                // Base par lettre: E < D < C < B < A
                // E = 100-199, D = 200-299, C = 300-399, B = 400-499, A = 500-599
                let base = 0;
                if (letter === 'E') base = 100;
                else if (letter === 'D') base = 200;
                else if (letter === 'C') base = 300;
                else if (letter === 'B') base = 400;
                else if (letter === 'A') base = 500;
                
                // Le chiffre est invers√©: 6 est plus faible que 0
                // Donc E6 (100 + (10-6)) = 104, E0 (100 + (10-0)) = 110
                return base + (10 - number);
            }
            
            return [...players].sort((a, b) => {
                const valA = getRankingValue(a.ranking);
                const valB = getRankingValue(b.ranking);
                return valA - valB; // Tri croissant : NC < E6 < ... < A0
            });
        }

        // Show Club Detail
        async function showClubDetail(code) {
            const club = state.clubs.find(c => c.code === code);
            if (!club) return;

            // Charger les donn√©es compl√®tes du club depuis l'API
            let clubData = club;
            try {
                const res = await fetch(`${API_BASE_URL}/api/clubs/${code}`);
                if (res.ok) {
                    clubData = await res.json();
                }
            } catch (e) {
                console.error(`Erreur lors du chargement du club ${code}:`, e);
            }

            // Charger TOUS les joueurs du club depuis l'API (sans limite)
            let clubPlayers = [];
            try {
                const res = await fetch(`${API_BASE_URL}/api/clubs/${code}/players?limit=10000`);
                if (res.ok) {
                    const data = await res.json();
                    clubPlayers = data.players || [];
                }
            } catch (e) {
                console.error(`Erreur lors du chargement des joueurs pour ${code}:`, e);
            }

            // Trier les joueurs par classement
            const sortedPlayers = sortPlayersByRanking(clubPlayers);

            // Construire le contenu avec les donn√©es du club
            let content = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;">${clubData.code} - ${clubData.name}</h2>
                    <button id="reload-club-btn" class="nav-btn" style="text-decoration: none; display: inline-block;">
                        üîÑ Recharger
                    </button>
                </div>
                
                <div class="info-grid" style="margin-bottom: 1.5rem;">
                    <div class="info-item">
                        <div class="info-label">Province</div>
                        <div class="info-value">${clubData.province || 'N/A'}</div>
                    </div>
                    ${clubData.full_name ? `<div class="info-item"><div class="info-label">Nom complet</div><div class="info-value">${clubData.full_name}</div></div>` : ''}
                    ${clubData.email ? `<div class="info-item"><div class="info-label">Email</div><div class="info-value">${clubData.email}</div></div>` : ''}
                    ${clubData.phone ? `<div class="info-item"><div class="info-label">T√©l√©phone</div><div class="info-value">${clubData.phone}</div></div>` : ''}
                </div>
            `;

            // Informations suppl√©mentaires du club
            if (clubData.venue_name || clubData.venue_address) {
                content += `
                    <div class="info-grid" style="margin-bottom: 1.5rem;">
                        ${clubData.venue_name ? `<div class="info-item"><div class="info-label">Local</div><div class="info-value">${clubData.venue_name}</div></div>` : ''}
                        ${clubData.venue_address ? `<div class="info-item"><div class="info-label">Adresse</div><div class="info-value">${clubData.venue_address}</div></div>` : ''}
                    </div>
                `;
            }

            // Tableau complet des membres tri√©s par classement
            if (sortedPlayers.length > 0) {
                content += `
                    <h3 style="margin: 1.5rem 0 1rem;">Membres (${sortedPlayers.length}) - Tri√©s par classement</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th style="text-align: left; padding: 0.75rem;">#</th>
                                    <th style="text-align: left; padding: 0.75rem;">Licence</th>
                                    <th style="text-align: left; padding: 0.75rem;">Nom</th>
                                    <th style="text-align: center; padding: 0.75rem;">Cat√©gorie</th>
                                    <th style="text-align: center; padding: 0.75rem;">Classement</th>
                                    <th style="text-align: right; padding: 0.75rem;">Points</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedPlayers.map((p, index) => `
                                    <tr onclick="showPlayerFromLicence('${p.licence}')" style="cursor: pointer; border-bottom: 1px solid var(--border);">
                                        <td style="padding: 0.75rem; color: var(--text-muted);">${index + 1}</td>
                                        <td style="padding: 0.75rem; font-family: monospace;">${p.licence}</td>
                                        <td style="padding: 0.75rem; font-weight: 500;">${p.name}</td>
                                        <td style="padding: 0.75rem; text-align: center;">${p.category || '-'}</td>
                                        <td style="padding: 0.75rem; text-align: center; font-weight: 600;">${p.ranking || 'NC'}</td>
                                        <td style="padding: 0.75rem; text-align: right; font-family: monospace;">${p.points_current ? p.points_current.toFixed(1) : '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                content += `
                    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid var(--primary); border-radius: 10px; padding: 1.5rem; margin-top: 1.5rem; text-align: center;">
                        <p style="color: var(--text-secondary); margin: 0; font-size: 1.1rem;">Aucun membre trouv√©.</p>
                        <p style="color: var(--text-muted); margin: 0.5rem 0 0 0;">Cliquez sur "Recharger" pour scraper les donn√©es du club.</p>
                    </div>
                `;
            }

            openDetail(`${clubData.code} - ${clubData.name}`, content);
            
            // Ajouter l'event listener pour le bouton Recharger
            const reloadBtn = document.getElementById('reload-club-btn');
            if (reloadBtn) {
                reloadBtn.onclick = () => reloadClubData(code);
            }
        }

        // Reload Club Data (scraping)
        async function reloadClubData(code) {
            const club = state.clubs.find(c => c.code === code);
            if (!club) return;

            // Afficher un message de chargement
            let content = `
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                    <h3>Scraping en cours...</h3>
                    <p style="color: var(--text-muted);">R√©cup√©ration des membres et fiches joueurs pour ${club.name}</p>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 1rem;">Cela peut prendre quelques instants...</p>
                </div>
            `;
            openDetail(`${club.code} - ${club.name}`, content);

            // Scraper le club
            try {
                const scrapeRes = await fetch(`${API_BASE_URL}/api/clubs/${code}/scrape`, {
                    method: 'POST'
                });
                
                if (!scrapeRes.ok) {
                    const errorData = await scrapeRes.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Erreur HTTP: ${scrapeRes.status}`);
                }
                
                const scrapeData = await scrapeRes.json();
                console.log('Scraping termin√©:', scrapeData);

                // Recharger les donn√©es du club depuis l'API
                await showClubDetail(code);
                
                // Afficher un message de succ√®s temporaire
                const detailContent = document.getElementById('detail-content');
                if (detailContent) {
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem;';
                    successMsg.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.5rem;">‚úÖ</span>
                            <strong style="color: var(--success);">Scraping termin√© avec succ√®s</strong>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">
                            ${scrapeData.members_scraped} membres ‚Ä¢ ${scrapeData.players_scraped} fiches joueurs
                            ${scrapeData.players_errors?.length > 0 ? `<br><span style="color: var(--warning);">‚ö†Ô∏è ${scrapeData.players_errors.length} erreur(s)</span>` : ''}
                        </div>
                    `;
                    detailContent.insertBefore(successMsg, detailContent.firstChild);
                    
                    // Supprimer le message apr√®s 5 secondes
                    setTimeout(() => {
                        successMsg.remove();
                    }, 5000);
                }
                
            } catch (e) {
                console.error(`Erreur lors du scraping du club ${code}:`, e);
                const detailContent = document.getElementById('detail-content');
                if (detailContent) {
                    const errorMsg = document.createElement('div');
                    errorMsg.style.cssText = 'background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem;';
                    errorMsg.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.5rem;">‚ùå</span>
                            <strong style="color: var(--error);">Erreur lors du scraping</strong>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">
                            ${e.message || 'Une erreur est survenue'}
                        </div>
                    `;
                    detailContent.insertBefore(errorMsg, detailContent.firstChild);
                    
                    // Supprimer le message apr√®s 5 secondes
                    setTimeout(() => {
                        errorMsg.remove();
                    }, 5000);
                }
            }
        }

        // Render Players
        function renderPlayers(filter = '') {
            const grid = document.getElementById('players-grid');
            const players = Object.values(state.players);
            const filtered = players.filter(p =>
                p.name?.toLowerCase().includes(filter.toLowerCase()) ||
                p.licence?.includes(filter) ||
                p.ranking?.toLowerCase().includes(filter.toLowerCase())
            );

            if (filtered.length === 0) {
                grid.innerHTML = `<p style="grid-column: 1/-1; color: var(--text-muted); text-align: center; padding: 3rem;">
                    Aucun joueur trouv√©. Assurez-vous que l'API est d√©marr√©e.
                </p>`;
                return;
            }

            grid.innerHTML = filtered.map(p => {
                const evolution = p.points_current - p.points_start;
                const evolutionClass = evolution >= 0 ? 'positive' : 'negative';
                return `
                    <div class="card" onclick="showPlayerDetail('${p.licence}')">
                        <div class="card-header">
                            <span class="card-badge">${p.ranking}</span>
                            <span class="card-title">${p.name}</span>
                        </div>
                        <div class="card-subtitle">Licence: ${p.licence}</div>
                        <div class="card-stats">
                            <div class="card-stat">üìä ${p.points_current?.toFixed(1) || 0} pts</div>
                            <div class="card-stat ${evolutionClass}">${evolution >= 0 ? '+' : ''}${evolution?.toFixed(1) || 0}</div>
                            <div class="card-stat">üéØ ${p.total_wins || 0}V - ${p.total_losses || 0}D</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show Player Detail
        async function showPlayerDetail(licence) {
            let player = state.players[licence];
            
            // Si le joueur n'est pas charg√© ou n'a pas toutes les donn√©es, charger depuis l'API
            if (!player || !player.stats_masculine) {
                try {
                    const res = await fetch(`${API_BASE_URL}/api/players/${licence}`);
                    if (res.ok) {
                        player = await res.json();
                        state.players[licence] = player;
                    } else {
                        alert(`Joueur ${licence} non trouv√©`);
                        return;
                    }
                } catch (e) {
                    console.error(`Erreur lors du chargement du joueur ${licence}:`, e);
                    alert(`Erreur lors du chargement. Assurez-vous que l'API est d√©marr√©e.`);
                    return;
                }
            }

            const evolution = (player.points_current || 0) - (player.points_start || 0);
            const evolutionClass = evolution >= 0 ? 'positive' : 'negative';

            let content = `
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Licence</div>
                        <div class="info-value">${player.licence}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Clt. Masculin</div>
                        <div class="info-value">${player.ranking || 'N/A'}</div>
                    </div>
                    ${player.women_ranking ? `
                    <div class="info-item">
                        <div class="info-label">Clt. F√©minin</div>
                        <div class="info-value" style="color: #ec4899;">${player.women_ranking}</div>
                    </div>
                    ` : ''}
                    <div class="info-item">
                        <div class="info-label">Points d√©part</div>
                        <div class="info-value">${player.points_start?.toFixed(1) || 0} pts</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Points actuels</div>
                        <div class="info-value">${player.points_current?.toFixed(1) || 0} pts</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">√âvolution</div>
                        <div class="info-value ${evolutionClass}">${evolution >= 0 ? '+' : ''}${evolution?.toFixed(1)} pts</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Ranking</div>
                        <div class="info-value">${player.ranking_position ? player.ranking_position + 'e' : 'N/A'}</div>
                    </div>
                </div>

                <h3 style="margin: 1.5rem 0 1rem;">Statistiques (Masculin)</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Victoires</div>
                        <div class="info-value positive">${player.total_wins || 0}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">D√©faites</div>
                        <div class="info-value negative">${player.total_losses || 0}</div>
                    </div>
                </div>
            `;

            // Stats par classement (depuis stats_masculine de l'API)
            const statsMasculine = player.stats_masculine || [];
            if (statsMasculine.length > 0) {
                content += `
                    <h3 style="margin: 1.5rem 0 1rem;">Stats par classement</h3>
                    <table class="data-table">
                        <thead>
                            <tr><th>Classement</th><th>V</th><th>D</th><th>Ratio</th></tr>
                        </thead>
                        <tbody>
                            ${statsMasculine.map(s => `
                                <tr>
                                    <td>${s.opponent_ranking}</td>
                                    <td>${s.wins}</td>
                                    <td>${s.losses}</td>
                                    <td>${s.ratio?.toFixed(1) || 0}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            // Matchs masculins (depuis matches_masculine de l'API)
            const matchesMasculine = player.matches_masculine || [];
            if (matchesMasculine.length > 0) {
                // Fonction pour parser une date DD/MM/YYYY en timestamp
                const parseDate = (dateStr) => {
                    if (!dateStr || dateStr === 'N/A') return 0;
                    const parts = dateStr.split('/');
                    if (parts.length !== 3) return 0;
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10);
                    const year = parseInt(parts[2], 10);
                    return new Date(year, month - 1, day).getTime();
                };
                
                // Grouper les matchs par journ√©e
                const matchesByDay = {};
                matchesMasculine.forEach(m => {
                    const key = `${m.date || 'N/A'}|${m.division || ''}|${m.opponent_club || ''}`;
                    if (!matchesByDay[key]) matchesByDay[key] = [];
                    matchesByDay[key].push(m);
                });

                content += `<h3 style="margin: 1.5rem 0 1rem;">Matchs par journ√©e</h3>`;
                
                // Trier les journ√©es par date d√©croissante (plus r√©cent en premier)
                const sortedDays = Object.entries(matchesByDay).sort(([keyA], [keyB]) => {
                    const dateA = keyA.split('|')[0];
                    const dateB = keyB.split('|')[0];
                    return parseDate(dateB) - parseDate(dateA); // D√©croissant
                });
                
                sortedDays.forEach(([key, matches]) => {
                    const [date, division, club] = key.split('|');
                    const wins = matches.filter(m => m.won).length;
                    const losses = matches.length - wins;
                    const totalPts = matches.reduce((acc, m) => acc + (m.points_change || 0), 0);
                    
                    content += `
                        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <div>
                                    <span style="color: var(--accent-secondary); font-weight: 600;">üìÖ ${date}</span>
                                    <span style="color: var(--text-muted); margin-left: 0.5rem;">${division}</span>
                                </div>
                                <div>
                                    <span style="color: var(--success);">${wins}V</span>
                                    <span style="color: var(--text-muted);">-</span>
                                    <span style="color: var(--error);">${losses}D</span>
                                    <span style="color: ${totalPts >= 0 ? 'var(--success)' : 'var(--error)'}; margin-left: 0.5rem;">
                                        ${totalPts >= 0 ? '+' : ''}${totalPts.toFixed(1)} pts
                                    </span>
                                </div>
                            </div>
                            <div style="font-weight: 600; margin-bottom: 0.75rem;">vs ${club}</div>
                            <table class="data-table" style="margin: 0;">
                                <thead>
                                    <tr><th>Score</th><th>Adversaire</th><th>Clt</th><th>Pts Adv</th><th>Gain</th></tr>
                                </thead>
                                <tbody>
                                    ${matches.map(m => `
                                        <tr>
                                            <td style="color: ${m.won ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">${m.score}</td>
                                            <td>${m.opponent_name}</td>
                                            <td>${m.opponent_ranking}</td>
                                            <td>${m.opponent_points ? m.opponent_points.toFixed(0) : ''}</td>
                                            <td style="color: ${(m.points_change || 0) >= 0 ? 'var(--success)' : 'var(--error)'}">
                                                ${m.points_change ? (m.points_change >= 0 ? '+' : '') + m.points_change.toFixed(1) : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                });
            }

            // Fiche f√©minine (depuis stats_feminine et matches_feminine de l'API)
            const statsFeminine = player.stats_feminine || [];
            const matchesFeminine = player.matches_feminine || [];
            if (statsFeminine.length > 0 || matchesFeminine.length > 0 || player.women_points_current) {
                content += `
                    <h3 style="margin: 1.5rem 0 1rem; color: #ec4899;">üìä Fiche F√©minine</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Points</div>
                            <div class="info-value">${player.women_points_current?.toFixed(1) || 0} pts</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Bilan</div>
                            <div class="info-value">${player.women_total_wins || 0}V - ${player.women_total_losses || 0}D</div>
                        </div>
                    </div>
                `;

                if (matchesFeminine.length > 0) {
                    // Fonction pour parser une date DD/MM/YYYY en timestamp
                    const parseDate = (dateStr) => {
                        if (!dateStr || dateStr === 'N/A') return 0;
                        const parts = dateStr.split('/');
                        if (parts.length !== 3) return 0;
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10);
                        const year = parseInt(parts[2], 10);
                        return new Date(year, month - 1, day).getTime();
                    };
                    
                    // Grouper les matchs f√©minins par journ√©e
                    const wMatchesByDay = {};
                    matchesFeminine.forEach(m => {
                        const key = `${m.date || 'N/A'}|${m.division || ''}|${m.opponent_club || ''}`;
                        if (!wMatchesByDay[key]) wMatchesByDay[key] = [];
                        wMatchesByDay[key].push(m);
                    });
                    
                    // Trier les journ√©es par date d√©croissante (plus r√©cent en premier)
                    const sortedDays = Object.entries(wMatchesByDay).sort(([keyA], [keyB]) => {
                        const dateA = keyA.split('|')[0];
                        const dateB = keyB.split('|')[0];
                        return parseDate(dateB) - parseDate(dateA); // D√©croissant
                    });
                    
                    sortedDays.forEach(([key, matches]) => {
                        const [date, division, club] = key.split('|');
                        const wins = matches.filter(m => m.won).length;
                        const losses = matches.length - wins;
                        const totalPts = matches.reduce((acc, m) => acc + (m.points_change || 0), 0);
                        
                        content += `
                            <div style="background: var(--bg-card); border: 1px solid #ec489920; border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <div>
                                        <span style="color: #ec4899; font-weight: 600;">üìÖ ${date}</span>
                                        <span style="color: var(--text-muted); margin-left: 0.5rem;">${division}</span>
                                    </div>
                                    <div>
                                        <span style="color: var(--success);">${wins}V</span>
                                        <span style="color: var(--text-muted);">-</span>
                                        <span style="color: var(--error);">${losses}D</span>
                                        <span style="color: ${totalPts >= 0 ? 'var(--success)' : 'var(--error)'}; margin-left: 0.5rem;">
                                            ${totalPts >= 0 ? '+' : ''}${totalPts.toFixed(1)} pts
                                        </span>
                                    </div>
                                </div>
                                <div style="font-weight: 600; margin-bottom: 0.75rem;">vs ${club}</div>
                                <table class="data-table" style="margin: 0;">
                                    <thead>
                                        <tr><th>Score</th><th>Adversaire</th><th>Clt</th><th>Pts Adv</th><th>Gain</th></tr>
                                    </thead>
                                    <tbody>
                                        ${matches.map(m => `
                                            <tr>
                                                <td style="color: ${m.won ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">${m.score}</td>
                                                <td>${m.opponent_name}</td>
                                                <td>${m.opponent_ranking}</td>
                                                <td>${m.opponent_points ? m.opponent_points.toFixed(0) : ''}</td>
                                                <td style="color: ${(m.points_change || 0) >= 0 ? 'var(--success)' : 'var(--error)'}">
                                                    ${m.points_change ? (m.points_change >= 0 ? '+' : '') + m.points_change.toFixed(1) : ''}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    });
                }
            }

            content += `
                <h3 style="margin: 1.5rem 0 1rem;">JSON brut</h3>
                <div class="json-viewer"><pre>${syntaxHighlight(player)}</pre></div>
            `;

            openPlayerDetail(`${player.licence} - ${player.name}`, content, player.licence);
        }

        async function showPlayerFromLicence(licence) {
            await showPlayerDetail(licence);
        }

        // Load members for a club from API
        async function loadClubMembers(clubCode) {
            if (state.members[clubCode]) {
                return; // D√©j√† charg√©
            }
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/clubs/${clubCode}/players`);
                if (res.ok) {
                    const data = await res.json();
                    // Convertir le format de l'API en format attendu par l'interface
                    state.members[clubCode] = {
                        club_code: clubCode,
                        club_name: data.club?.name || clubCode,
                        members: (data.players || []).map(p => ({
                            licence: p.licence,
                            name: p.name,
                            category: p.category,
                            ranking: p.ranking
                        }))
                    };
                }
            } catch (e) {
                console.error(`Erreur lors du chargement des membres pour ${clubCode}:`, e);
            }
        }

        // Search handlers
        document.getElementById('clubs-search').addEventListener('input', (e) => {
            if (state.viewMode === 'clubs') {
                renderClubs(e.target.value);
            }
        });
        
        // Back button
        document.getElementById('back-to-regions-btn').addEventListener('click', backToRegions);
        
        // Reload clubs button
        document.getElementById('reload-clubs-btn').addEventListener('click', reloadClubsForSelectedRegion);
        
        // Refresh clubs names button (fix N/A names)
        document.getElementById('refresh-clubs-names-btn').addEventListener('click', refreshClubsNames);
        
        // Region select change
        document.getElementById('region-select').addEventListener('change', async (e) => {
            const province = e.target.value;
            if (province) {
                await showProvinceClubs(province);
            } else {
                await backToRegions();
            }
        });
        document.getElementById('players-search').addEventListener('input', (e) => renderPlayers(e.target.value));
        
        // Charger les membres quand on clique sur un club
        document.addEventListener('click', async (e) => {
            });

        // Load provinces list
        async function loadProvincesList() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/clubs/provinces`);
                if (res.ok) {
                    const data = await res.json();
                    const provinces = data.provinces || [];
                    
                    const select = document.getElementById('region-select');
                    if (select) {
                        select.innerHTML = '<option value="">Toutes les r√©gions</option>';
                        provinces.forEach(province => {
                            const option = document.createElement('option');
                            option.value = province;
                            option.textContent = province;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (e) {
                console.error('Erreur lors du chargement des provinces:', e);
            }
        }
        
        // Load clubs for a province from API
        async function loadClubsForProvince(province) {
            try {
                const url = province 
                    ? `${API_BASE_URL}/api/clubs?province=${encodeURIComponent(province)}`
                    : `${API_BASE_URL}/api/clubs`;
                
                const res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    state.clubs = data.clubs || data;
                    console.log(`‚úÖ ${state.clubs.length} clubs charg√©s${province ? ` pour ${province}` : ''}`);
                    return true;
                }
            } catch (e) {
                console.error(`Erreur lors du chargement des clubs pour ${province}:`, e);
            }
            return false;
        }
        async function loadFromAPI() {
            try {
                // Load provinces list
                await loadProvincesList();
                
                // Load clubs (tous les clubs pour calculer les r√©gions)
                await loadClubsForProvince('');
                renderRegions();

                // Load players (on charge les premiers pour l'affichage)
                const playersRes = await fetch(`${API_BASE_URL}/api/players?limit=500`);
                if (playersRes.ok) {
                    const playersData = await playersRes.json();
                    const playersList = playersData.players || playersData;
                    // Convertir la liste en objet index√© par licence
                    playersList.forEach(player => {
                        state.players[player.licence] = player;
                    });
                    renderPlayers();
                }

                // Pour les membres, on les charge √† la demande quand un club est s√©lectionn√©
                // via l'endpoint /api/clubs/{code}/players

                await updateStats();
                console.log('‚úÖ Donn√©es charg√©es depuis l\'API FastAPI');
            } catch (e) {
                console.error('‚ùå Erreur lors du chargement depuis l\'API:', e);
                console.log('‚ÑπÔ∏è Assurez-vous que l\'API est d√©marr√©e: python main.py api');
            }
        }

        // =============================================================================
        // ADMIN - Scraping automatique
        // =============================================================================
        
        let scrapeStatusInterval = null;
        let scrapeLogsInterval = null;
        let terminalExpanded = true;
        let lastLogCount = 0;
        
        async function startFullScrape() {
            if (!confirm('üöÄ Lancer le scraping complet de tous les clubs ?\n\nCette op√©ration peut prendre 2-3 heures.')) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/scrape/all`, { method: 'POST' });
                const data = await res.json();
                
                if (res.ok) {
                    showToast(`‚úÖ Scraping lanc√©: ${data.total_clubs} clubs`, 'success');
                    lastLogCount = 0;
                    startScrapeStatusPolling();
                    loadScrapeStatus();
                } else {
                    if (data.detail?.task_id) {
                        showToast(`‚ö†Ô∏è Scraping d√©j√† en cours (t√¢che #${data.detail.task_id})`, 'info');
                        lastLogCount = 0;
                        startScrapeStatusPolling();
                        loadScrapeStatus();
                    } else {
                        showToast(`‚ùå Erreur: ${data.detail || 'Erreur inconnue'}`, 'error');
                    }
                }
            } catch (e) {
                showToast(`‚ùå Erreur: ${e.message}`, 'error');
            }
        }
        
        async function cancelScrape() {
            if (!confirm('Annuler le scraping en cours ?')) return;
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/scrape/cancel`, { method: 'POST' });
                if (res.ok) {
                    showToast('Scraping annul√©', 'info');
                    stopScrapeStatusPolling();
                    loadScrapeStatus();
                }
            } catch (e) {
                showToast(`‚ùå Erreur: ${e.message}`, 'error');
            }
        }
        
        function formatDuration(seconds) {
            if (!seconds) return '-';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            if (h > 0) return `${h}h ${m}m ${s}s`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        }
        
        async function loadScrapeStatus() {
            const container = document.getElementById('current-task-content');
            const btn = document.getElementById('start-scrape-btn');
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/scrape/status`);
                const data = await res.json();
                
                if (data.running) {
                    btn.style.display = 'none';
                    startScrapeStatusPolling();
                    
                    // D√©marrer le polling des logs
                    if (data.task_id) {
                        startScrapeLogsPolling(data.task_id);
                    }
                    
                    // Afficher le terminal
                    const terminalContainer = document.getElementById('scrape-terminal-container');
                    if (terminalContainer) {
                        terminalContainer.style.display = 'block';
                    }
                    
                    container.innerHTML = `
                        <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <span style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="status-dot running"></span>
                                    <strong>T√¢che #${data.task_id}</strong>
                                </span>
                                <span style="color: var(--accent); font-weight: bold;">${data.progress_percent}%</span>
                            </div>
                            
                            <div style="background: var(--bg-tertiary); border-radius: 6px; height: 16px; overflow: hidden; margin-bottom: 1rem;">
                                <div style="background: linear-gradient(90deg, var(--accent), var(--accent-light)); height: 100%; width: ${data.progress_percent}%; transition: width 0.5s;"></div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center; margin-bottom: 1rem;">
                                <div>
                                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--accent);">${data.completed_clubs}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">/ ${data.total_clubs} clubs</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--success);">${(data.total_players || 0).toLocaleString()}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">joueurs</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.3rem; font-weight: bold; color: ${data.errors_count > 0 ? 'var(--danger)' : 'var(--text-muted)'}">${data.errors_count || 0}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">erreurs</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.3rem; font-weight: bold;">${formatDuration(data.elapsed_seconds)}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">√©coul√©</div>
                                </div>
                            </div>
                            
                            ${data.current_club ? `
                                <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
                                    <span style="color: var(--text-muted);">En cours:</span>
                                    <strong style="color: var(--accent-light);"> ${data.current_club}</strong>
                                    <span style="color: var(--text-muted);"> (${data.current_province})</span>
                                </div>
                            ` : ''}
                            
                            <button onclick="cancelScrape()" class="btn btn-secondary" style="width: 100%;">
                                ‚èπÔ∏è Annuler le scraping
                            </button>
                        </div>
                    `;
                } else {
                    btn.style.display = 'inline-flex';
                    stopScrapeStatusPolling();
                    stopScrapeLogsPolling();
                    
                    // Masquer le terminal
                    const terminalContainer = document.getElementById('scrape-terminal-container');
                    if (terminalContainer) {
                        terminalContainer.style.display = 'none';
                    }
                    
                    container.innerHTML = `<p style="color: var(--text-muted);">Aucun scraping en cours</p>`;
                }
            } catch (e) {
                container.innerHTML = `<p style="color: var(--danger);">Erreur de chargement: ${e.message}</p>`;
            }
        }
        
        function startScrapeStatusPolling() {
            if (scrapeStatusInterval) return;
            scrapeStatusInterval = setInterval(loadScrapeStatus, 3000);
        }
        
        function stopScrapeStatusPolling() {
            if (scrapeStatusInterval) {
                clearInterval(scrapeStatusInterval);
                scrapeStatusInterval = null;
            }
        }
        
        async function loadScrapeLogs(taskId) {
            const terminal = document.getElementById('scrape-terminal');
            if (!terminal) return;
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/scrape/logs/${taskId}`);
                const data = await res.json();
                
                if (data.logs && data.logs.length > 0) {
                    // Ne mettre √† jour que si de nouveaux logs sont arriv√©s
                    if (data.logs.length > lastLogCount) {
                        const logsHtml = data.logs.map(log => {
                            let color = 'var(--text-primary)';
                            let bgColor = 'transparent';
                            let padding = '0.15rem 0';
                            let fontSize = '0.85rem';
                            let marginLeft = '0';
                            
                            // Logs de joueurs avec donn√©es
                            if (log.message.includes('[JOUEUR]')) {
                                color = '#60a5fa'; // Bleu clair
                                bgColor = 'rgba(96, 165, 250, 0.1)';
                                padding = '0.35rem 0.5rem';
                                fontSize = '0.9rem';
                            }
                            // Logs de matchs (sous-logs)
                            else if (log.message.includes('‚îî‚îÄ')) {
                                marginLeft = '1.5rem';
                                fontSize = '0.8rem';
                                if (log.message.includes('‚úÖ')) {
                                    color = '#34d399'; // Vert
                                } else if (log.message.includes('‚ùå')) {
                                    color = '#f87171'; // Rouge
                                }
                            }
                            // Logs de clubs
                            else if (log.message.includes('[DB] ‚úÖ Club')) {
                                color = '#a78bfa'; // Violet
                                bgColor = 'rgba(167, 139, 250, 0.1)';
                                padding = '0.35rem 0.5rem';
                            }
                            // Logs de scrape club termin√©
                            else if (log.message.includes('[SCRAPE] ‚úÖ')) {
                                color = '#34d399'; // Vert
                                bgColor = 'rgba(52, 211, 153, 0.15)';
                                padding = '0.4rem 0.5rem';
                                fontSize = '0.95rem';
                            }
                            // Erreurs
                            else if (log.message.includes('‚ùå') || log.message.includes('WARNING') || log.message.includes('Erreur')) {
                                color = '#fbbf24'; // Jaune/Orange
                            }
                            // Logs de progression
                            else if (log.message.includes('üìä')) {
                                color = '#38bdf8'; // Cyan
                            }
                            // D√©marrage
                            else if (log.message.includes('D√©marrage')) {
                                color = '#c084fc'; // Violet clair
                                bgColor = 'rgba(192, 132, 252, 0.1)';
                                padding = '0.4rem 0.5rem';
                            }
                            
                            return `<div style="color: ${color}; background: ${bgColor}; padding: ${padding}; margin-bottom: 0.15rem; margin-left: ${marginLeft}; border-radius: 4px; font-size: ${fontSize};">
                                <span style="color: var(--text-muted); font-size: 0.75rem;">[${log.timestamp}]</span> ${log.message}
                            </div>`;
                        }).join('');
                        
                        terminal.innerHTML = logsHtml;
                        lastLogCount = data.logs.length;
                        
                        // Auto-scroll vers le bas si le terminal est √©tendu
                        if (terminalExpanded) {
                            terminal.scrollTop = terminal.scrollHeight;
                        }
                    }
                }
            } catch (e) {
                // Erreur silencieuse pour ne pas polluer la console
            }
        }
        
        function startScrapeLogsPolling(taskId) {
            if (scrapeLogsInterval) return;
            lastLogCount = 0;
            // Charger imm√©diatement
            loadScrapeLogs(taskId);
            scrapeLogsInterval = setInterval(() => {
                loadScrapeLogs(taskId);
            }, 1000); // Rafra√Æchir toutes les secondes pour voir en temps r√©el
        }
        
        function stopScrapeLogsPolling() {
            if (scrapeLogsInterval) {
                clearInterval(scrapeLogsInterval);
                scrapeLogsInterval = null;
            }
            lastLogCount = 0;
        }
        
        function toggleTerminal() {
            const terminal = document.getElementById('scrape-terminal');
            const toggleText = document.getElementById('terminal-toggle-text');
            
            if (!terminal || !toggleText) return;
            
            terminalExpanded = !terminalExpanded;
            
            if (terminalExpanded) {
                terminal.style.maxHeight = '600px';
                terminal.style.minHeight = '300px';
                toggleText.textContent = '‚ñº R√©duire';
            } else {
                terminal.style.maxHeight = '150px';
                terminal.style.minHeight = '150px';
                toggleText.textContent = '‚ñ≤ Agrandir';
            }
        }
        
        async function loadScrapeHistory() {
            const container = document.getElementById('scrape-history');
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/scrape/history?limit=20`);
                const data = await res.json();
                
                if (!data.tasks || data.tasks.length === 0) {
                    container.innerHTML = `<p style="color: var(--text-muted);">Aucune t√¢che dans l'historique</p>`;
                    return;
                }
                
                const statusBadge = (status) => {
                    const badges = {
                        'running': '<span class="badge" style="background: var(--accent); color: white;">üîÑ En cours</span>',
                        'success': '<span class="badge" style="background: var(--success); color: white;">‚úÖ Succ√®s</span>',
                        'failed': '<span class="badge" style="background: var(--danger); color: white;">‚ùå √âchec</span>',
                        'cancelled': '<span class="badge" style="background: var(--text-muted); color: white;">‚èπÔ∏è Annul√©</span>'
                    };
                    return badges[status] || status;
                };
                
                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const d = new Date(dateStr);
                        return d.toLocaleString('fr-FR', { 
                            day: '2-digit', month: '2-digit', year: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        });
                    } catch { return dateStr; }
                };
                
                container.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table class="data-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Date</th>
                                    <th>Statut</th>
                                    <th>Clubs</th>
                                    <th>Joueurs</th>
                                    <th>Erreurs</th>
                                    <th>Dur√©e</th>
                                    <th>Source</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.tasks.map(task => `
                                    <tr>
                                        <td>${task.id}</td>
                                        <td style="white-space: nowrap;">${formatDate(task.started_at)}</td>
                                        <td>${statusBadge(task.status)}</td>
                                        <td>${task.completed_clubs}/${task.total_clubs}</td>
                                        <td>${(task.total_players || 0).toLocaleString()}</td>
                                        <td style="color: ${task.errors_count > 0 ? 'var(--danger)' : 'inherit'}">${task.errors_count || 0}</td>
                                        <td>${formatDuration(task.duration_seconds)}</td>
                                        <td><span class="badge" style="background: ${task.trigger_type === 'cron' ? 'var(--accent)' : 'var(--bg-tertiary)'}; font-size: 0.75rem;">${task.trigger_type === 'cron' ? '‚è∞ Cron' : 'üë§ Manuel'}</span></td>
                                        <td>
                                            <button onclick="showTaskDetails(${task.id})" class="btn btn-outline" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">
                                                ${task.errors_count > 0 ? 'üîç Voir erreurs' : 'üìã D√©tails'}
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<p style="color: var(--danger);">Erreur: ${e.message}</p>`;
            }
        }

        async function showTaskDetails(taskId) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/scrape/task/${taskId}`);
                const task = await res.json();
                
                if (!res.ok) {
                    throw new Error(task.detail || 'Erreur lors du chargement des d√©tails');
                }
                
                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const d = new Date(dateStr);
                        return d.toLocaleString('fr-FR', { 
                            day: '2-digit', month: '2-digit', year: 'numeric',
                            hour: '2-digit', minute: '2-digit', second: '2-digit'
                        });
                    } catch { return dateStr; }
                };
                
                const formatDuration = (seconds) => {
                    if (!seconds) return '-';
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    const s = Math.floor(seconds % 60);
                    if (h > 0) return `${h}h ${m}m ${s}s`;
                    if (m > 0) return `${m}m ${s}s`;
                    return `${s}s`;
                };
                
                const statusBadge = (status) => {
                    const badges = {
                        'running': '<span class="badge" style="background: var(--accent); color: white;">üîÑ En cours</span>',
                        'success': '<span class="badge" style="background: var(--success); color: white;">‚úÖ Succ√®s</span>',
                        'failed': '<span class="badge" style="background: var(--danger); color: white;">‚ùå √âchec</span>',
                        'cancelled': '<span class="badge" style="background: var(--text-muted); color: white;">‚èπÔ∏è Annul√©</span>'
                    };
                    return badges[status] || status;
                };
                
                let errorsHtml = '';
                if (task.errors_list && task.errors_list.length > 0) {
                    errorsHtml = `
                        <div style="margin-top: 1.5rem;">
                            <h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--danger);">
                                ‚ùå Erreurs (${task.errors_list.length})
                            </h3>
                            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; max-height: 400px; overflow-y: auto;">
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    ${task.errors_list.map((error, index) => `
                                        <li style="padding: 0.75rem; margin-bottom: 0.5rem; background: var(--bg-card); border-left: 3px solid var(--danger); border-radius: 4px;">
                                            <div style="display: flex; align-items: start; gap: 0.5rem;">
                                                <span style="color: var(--danger); font-weight: 600;">#${index + 1}</span>
                                                <span style="flex: 1; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--text-secondary); word-break: break-word;">${error}</span>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    errorsHtml = `
                        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; text-align: center; color: var(--text-muted);">
                            ‚úÖ Aucune erreur
                        </div>
                    `;
                }
                
                detailTitle.textContent = `D√©tails de la t√¢che #${task.id}`;
                detailContent.innerHTML = `
                    <div style="display: grid; gap: 1.5rem;">
                        <div>
                            <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--text-secondary);">Informations g√©n√©rales</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Statut</div>
                                    <div>${statusBadge(task.status)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Source</div>
                                    <div><span class="badge" style="background: ${task.trigger_type === 'cron' ? 'var(--accent)' : 'var(--bg-tertiary)'}; font-size: 0.75rem;">${task.trigger_type === 'cron' ? '‚è∞ Cron' : 'üë§ Manuel'}</span></div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">D√©but</div>
                                    <div style="font-size: 0.9rem;">${formatDate(task.started_at)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Fin</div>
                                    <div style="font-size: 0.9rem;">${formatDate(task.finished_at)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Dur√©e</div>
                                    <div style="font-size: 0.9rem;">${formatDuration(task.duration_seconds || (task.started_at && task.finished_at ? (new Date(task.finished_at) - new Date(task.started_at)) / 1000 : null))}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--text-secondary);">Statistiques</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Clubs</div>
                                    <div style="font-size: 1.2rem; font-weight: 600;">${task.completed_clubs || 0}/${task.total_clubs || 0}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Joueurs</div>
                                    <div style="font-size: 1.2rem; font-weight: 600;">${(task.total_players || 0).toLocaleString()}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Erreurs</div>
                                    <div style="font-size: 1.2rem; font-weight: 600; color: ${task.errors_count > 0 ? 'var(--danger)' : 'var(--success)'};">${task.errors_count || 0}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${task.current_club || task.current_province ? `
                            <div>
                                <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--text-secondary);">Progression</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                    ${task.current_province ? `
                                        <div>
                                            <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Province actuelle</div>
                                            <div>${task.current_province}</div>
                                        </div>
                                    ` : ''}
                                    ${task.current_club ? `
                                        <div>
                                            <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Club actuel</div>
                                            <div>${task.current_club}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${errorsHtml}
                    </div>
                `;
                
                openDetail();
            } catch (e) {
                alert(`Erreur lors du chargement des d√©tails: ${e.message}`);
            }
        }

        // =============================================================================
        // TOURNAMENTS
        // =============================================================================
        
        // State pour les tournois
        state.tournaments = [];
        state.tournamentLevels = [];
        state.selectedTournament = null;
        state.tournamentViewMode = 'list'; // 'list' ou 'detail'
        
        // Charger les tournois depuis l'API
        async function loadTournaments(level = '', search = '') {
            try {
                let url = `${API_BASE_URL}/api/tournaments?limit=500`;
                if (level) url += `&level=${encodeURIComponent(level)}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                
                const res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    state.tournaments = data.tournaments || [];
                    console.log(`‚úÖ ${state.tournaments.length} tournois charg√©s`);
                }
            } catch (e) {
                console.error('Erreur lors du chargement des tournois:', e);
            }
        }
        
        // Charger les niveaux de tournois
        async function loadTournamentLevels() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/tournaments/levels`);
                if (res.ok) {
                    const data = await res.json();
                    state.tournamentLevels = data.levels || [];
                    
                    // Remplir le select
                    const select = document.getElementById('tournament-level-select');
                    if (select) {
                        select.innerHTML = '<option value="">Tous les niveaux</option>';
                        state.tournamentLevels.forEach(level => {
                            select.innerHTML += `<option value="${level}">${level}</option>`;
                        });
                    }
                }
            } catch (e) {
                console.error('Erreur lors du chargement des niveaux:', e);
            }
        }
        
        // Afficher les tournois
        function renderTournaments() {
            const grid = document.getElementById('tournaments-grid');
            if (!grid) return;
            
            if (!state.tournaments || state.tournaments.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üèÜ</div>
                        <p>Aucun tournoi trouv√©</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Cliquez sur "Scraper les tournois" pour r√©cup√©rer la liste</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = state.tournaments.map(t => `
                <div class="card" onclick="showTournamentDetail(${t.t_id})" style="cursor: pointer;">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: start; gap: 0.5rem;">
                        <span style="flex: 1;">${t.name}</span>
                        <span style="font-size: 0.75rem; background: var(--accent-primary); color: white; padding: 0.2rem 0.5rem; border-radius: 4px; white-space: nowrap;">${t.series_count} s√©rie${t.series_count > 1 ? 's' : ''}</span>
                    </div>
                    <div class="card-subtitle" style="margin-top: 0.5rem;">
                        <span style="color: var(--accent-secondary);">${t.level || 'N/A'}</span>
                    </div>
                    <div class="card-subtitle" style="margin-top: 0.25rem; display: flex; justify-content: space-between; align-items: center;">
                        <span>üìÖ ${t.date_start || 'N/A'}${t.date_end && t.date_end !== t.date_start ? ' - ' + t.date_end : ''}</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted);">${t.reference || ''}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // Afficher les d√©tails d'un tournoi
        async function showTournamentDetail(t_id) {
            const grid = document.getElementById('tournaments-grid');
            const listHeader = document.getElementById('tournaments-list-header');
            const detailHeader = document.getElementById('tournament-detail-header');
            
            // Changer la vue
            state.tournamentViewMode = 'detail';
            state.selectedTournament = t_id;
            listHeader.style.display = 'none';
            detailHeader.style.display = 'flex';
            
            // Afficher loading
            grid.innerHTML = `<p style="grid-column: 1/-1; color: var(--text-muted); text-align: center; padding: 3rem;">Chargement des d√©tails...</p>`;
            
            try {
                // Charger les infos du tournoi (avec les r√©sultats)
                const [tournamentRes, seriesRes, inscriptionsRes, resultsRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/tournaments/${t_id}`),
                    fetch(`${API_BASE_URL}/api/tournaments/${t_id}/series`),
                    fetch(`${API_BASE_URL}/api/tournaments/${t_id}/inscriptions`),
                    fetch(`${API_BASE_URL}/api/tournaments/${t_id}/results`)
                ]);
                
                const tournament = tournamentRes.ok ? await tournamentRes.json() : null;
                const seriesData = seriesRes.ok ? await seriesRes.json() : { series: [] };
                const inscriptionsData = inscriptionsRes.ok ? await inscriptionsRes.json() : { inscriptions: [] };
                const resultsData = resultsRes.ok ? await resultsRes.json() : { results: [] };
                
                if (!tournament) {
                    grid.innerHTML = `<p style="grid-column: 1/-1; color: var(--error); text-align: center; padding: 3rem;">Tournoi non trouv√©</p>`;
                    return;
                }
                
                document.getElementById('tournament-detail-title').textContent = tournament.name;
                
                // Grouper les inscriptions par s√©rie
                const inscriptionsBySeries = {};
                inscriptionsData.inscriptions.forEach(i => {
                    const key = i.series_name || 'Sans s√©rie';
                    if (!inscriptionsBySeries[key]) {
                        inscriptionsBySeries[key] = [];
                    }
                    inscriptionsBySeries[key].push(i);
                });
                
                // Grouper les r√©sultats par s√©rie
                const resultsBySeries = {};
                resultsData.results.forEach(r => {
                    const key = r.series_name || 'Sans s√©rie';
                    if (!resultsBySeries[key]) {
                        resultsBySeries[key] = [];
                    }
                    resultsBySeries[key].push(r);
                });
                
                // Fonction pour g√©n√©rer le HTML des inscriptions d'une s√©rie
                const renderSeriesInscriptions = (seriesName) => {
                    const inscriptions = inscriptionsBySeries[seriesName] || [];
                    if (inscriptions.length === 0) return '<p style="color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem 0;">Aucune inscription</p>';
                    
                    return `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                            ${inscriptions.map(i => `
                                <div style="background: var(--bg-secondary); padding: 0.5rem 0.75rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 500; font-size: 0.9rem;">${i.player_name}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">${i.player_club || 'N/A'}</div>
                                    </div>
                                    <span style="background: var(--accent-glow); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">${i.player_ranking || 'NC'}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                };
                
                // Fonction pour g√©n√©rer le HTML des r√©sultats d'une s√©rie
                const renderSeriesResults = (seriesName) => {
                    const results = resultsBySeries[seriesName] || [];
                    if (results.length === 0) return '<p style="color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem 0;">Aucun r√©sultat</p>';
                    
                    return `
                        <div style="display: grid; gap: 0.5rem; margin-top: 0.5rem;">
                            ${results.map(r => {
                                const isPlayer1Winner = r.winner_licence === r.player1_licence;
                                const isPlayer2Winner = r.winner_licence === r.player2_licence;
                                return `
                                    <div style="background: var(--bg-secondary); padding: 0.75rem; border-radius: 6px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                            <div style="flex: 1; min-width: 150px;">
                                                <div style="font-weight: ${isPlayer1Winner ? '700' : '400'}; color: ${isPlayer1Winner ? 'var(--success)' : 'var(--text-primary)'};">
                                                    ${isPlayer1Winner ? 'üèÜ ' : ''}${r.player1_name || 'N/A'}
                                                </div>
                                            </div>
                                            <div style="font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 1.1rem; background: var(--bg-card); padding: 0.25rem 0.75rem; border-radius: 4px;">
                                                ${r.score || '-'}
                                            </div>
                                            <div style="flex: 1; min-width: 150px; text-align: right;">
                                                <div style="font-weight: ${isPlayer2Winner ? '700' : '400'}; color: ${isPlayer2Winner ? 'var(--success)' : 'var(--text-primary)'};">
                                                    ${r.player2_name || 'N/A'}${isPlayer2Winner ? ' üèÜ' : ''}
                                                </div>
                                            </div>
                                        </div>
                                        ${r.round ? `<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; text-align: center;">${r.round}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                };
                
                grid.innerHTML = `
                    <div style="grid-column: 1/-1;">
                        <!-- Infos tournoi -->
                        <div style="background: var(--bg-card); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">Niveau</div>
                                    <div style="font-weight: 600;">${tournament.level || 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">Date</div>
                                    <div style="font-weight: 600;">${tournament.date_start || 'N/A'}${tournament.date_end && tournament.date_end !== tournament.date_start ? ' - ' + tournament.date_end : ''}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">R√©f√©rence</div>
                                    <div style="font-weight: 600; font-family: 'JetBrains Mono', monospace;">${tournament.reference || 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">S√©ries</div>
                                    <div style="font-weight: 600;">${tournament.series_count || seriesData.series.length}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">Inscriptions</div>
                                    <div style="font-weight: 600;">${inscriptionsData.inscriptions.length}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">R√©sultats</div>
                                    <div style="font-weight: 600;">${resultsData.results.length}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- S√©ries avec onglets inscrits/r√©sultats -->
                        <h3 style="font-size: 1.2rem; margin-bottom: 1rem;">üìã S√©ries (${seriesData.series.length})</h3>
                        ${seriesData.series.length > 0 ? `
                            <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                                ${seriesData.series.map((s, idx) => `
                                    <div style="background: var(--bg-card); border-radius: 8px; overflow: hidden;">
                                        <div style="padding: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; border-bottom: 1px solid var(--border);">
                                            <div style="font-weight: 600; font-size: 1.1rem;">${s.series_name}</div>
                                            <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: var(--text-muted);">
                                                ${s.date ? `<span>üìÖ ${s.date}</span>` : ''}
                                                ${s.time ? `<span>üïê ${s.time}</span>` : ''}
                                                <span>üë• ${s.inscriptions_count}${s.inscriptions_max ? '/' + s.inscriptions_max : ''}</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Onglets -->
                                        <div style="display: flex; border-bottom: 1px solid var(--border);">
                                            <button onclick="showSeriesTab(${idx}, 'inscriptions')" id="tab-inscriptions-${idx}" class="series-tab active" style="flex: 1; padding: 0.75rem; background: var(--bg-secondary); border: none; color: var(--text-primary); cursor: pointer; font-weight: 500;">
                                                üë• Inscrits (${(inscriptionsBySeries[s.series_name] || []).length})
                                            </button>
                                            <button onclick="showSeriesTab(${idx}, 'results')" id="tab-results-${idx}" class="series-tab" style="flex: 1; padding: 0.75rem; background: transparent; border: none; color: var(--text-muted); cursor: pointer;">
                                                üèÜ R√©sultats (${(resultsBySeries[s.series_name] || []).length})
                                            </button>
                                        </div>
                                        
                                        <!-- Contenu -->
                                        <div style="padding: 1rem;">
                                            <div id="content-inscriptions-${idx}" class="series-content">${renderSeriesInscriptions(s.series_name)}</div>
                                            <div id="content-results-${idx}" class="series-content" style="display: none;">${renderSeriesResults(s.series_name)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="color: var(--text-muted); margin-bottom: 2rem;">Aucune s√©rie disponible</p>'}
                        
                        <!-- R√©sum√© global des r√©sultats -->
                        ${resultsData.results.length > 0 ? `
                            <h3 style="font-size: 1.2rem; margin-bottom: 1rem;">üèÜ Tous les r√©sultats (${resultsData.results.length})</h3>
                            <div style="background: var(--bg-card); border-radius: 8px; overflow: hidden; max-height: 500px; overflow-y: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="position: sticky; top: 0; background: var(--bg-secondary);">
                                        <tr>
                                            <th style="padding: 0.75rem; text-align: left; font-size: 0.85rem; color: var(--text-muted);">S√©rie</th>
                                            <th style="padding: 0.75rem; text-align: left; font-size: 0.85rem; color: var(--text-muted);">Joueur 1</th>
                                            <th style="padding: 0.75rem; text-align: center; font-size: 0.85rem; color: var(--text-muted);">Score</th>
                                            <th style="padding: 0.75rem; text-align: right; font-size: 0.85rem; color: var(--text-muted);">Joueur 2</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${resultsData.results.map(r => {
                                            const isPlayer1Winner = r.winner_licence === r.player1_licence;
                                            const isPlayer2Winner = r.winner_licence === r.player2_licence;
                                            return `
                                                <tr style="border-top: 1px solid var(--border);">
                                                    <td style="padding: 0.75rem; font-size: 0.85rem; color: var(--text-muted);">${r.series_name || '-'}</td>
                                                    <td style="padding: 0.75rem; font-weight: ${isPlayer1Winner ? '700' : '400'}; color: ${isPlayer1Winner ? 'var(--success)' : 'inherit'};">
                                                        ${isPlayer1Winner ? 'üèÜ ' : ''}${r.player1_name || 'N/A'}
                                                    </td>
                                                    <td style="padding: 0.75rem; text-align: center; font-family: 'JetBrains Mono', monospace; font-weight: 600;">${r.score || '-'}</td>
                                                    <td style="padding: 0.75rem; text-align: right; font-weight: ${isPlayer2Winner ? '700' : '400'}; color: ${isPlayer2Winner ? 'var(--success)' : 'inherit'};">
                                                        ${r.player2_name || 'N/A'}${isPlayer2Winner ? ' üèÜ' : ''}
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}
                    </div>
                `;
            } catch (e) {
                console.error('Erreur chargement tournoi:', e);
                grid.innerHTML = `<p style="grid-column: 1/-1; color: var(--error); text-align: center; padding: 3rem;">Erreur: ${e.message}</p>`;
            }
        }
        
        // Fonction pour basculer entre les onglets inscrits/r√©sultats
        function showSeriesTab(seriesIdx, tab) {
            // Cacher tous les contenus de cette s√©rie
            document.getElementById(`content-inscriptions-${seriesIdx}`).style.display = 'none';
            document.getElementById(`content-results-${seriesIdx}`).style.display = 'none';
            
            // D√©sactiver tous les onglets
            document.getElementById(`tab-inscriptions-${seriesIdx}`).style.background = 'transparent';
            document.getElementById(`tab-inscriptions-${seriesIdx}`).style.color = 'var(--text-muted)';
            document.getElementById(`tab-results-${seriesIdx}`).style.background = 'transparent';
            document.getElementById(`tab-results-${seriesIdx}`).style.color = 'var(--text-muted)';
            
            // Afficher le contenu s√©lectionn√©
            document.getElementById(`content-${tab}-${seriesIdx}`).style.display = 'block';
            document.getElementById(`tab-${tab}-${seriesIdx}`).style.background = 'var(--bg-secondary)';
            document.getElementById(`tab-${tab}-${seriesIdx}`).style.color = 'var(--text-primary)';
        }
        
        // Retour √† la liste des tournois
        function backToTournamentsList() {
            state.tournamentViewMode = 'list';
            state.selectedTournament = null;
            
            document.getElementById('tournaments-list-header').style.display = 'flex';
            document.getElementById('tournament-detail-header').style.display = 'none';
            
            renderTournaments();
        }
        
        // Scraper les tournois
        async function scrapeTournaments() {
            if (!confirm('üèÜ Lancer le scraping des tournois ?\n\nCela peut prendre 15-30 minutes pour r√©cup√©rer tous les tournois, s√©ries et inscriptions.')) {
                return;
            }
            
            const btn = document.getElementById('scrape-tournaments-btn');
            const statusDiv = document.getElementById('tournaments-scrape-status');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Scraping en cours...';
            statusDiv.style.display = 'block';
            
            try {
                // Lancer le scraping
                const res = await fetch(`${API_BASE_URL}/api/scrape/tournaments`, {
                    method: 'POST'
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail?.error || 'Erreur lors du lancement');
                }
                
                const data = await res.json();
                showToast(`‚úÖ Scraping lanc√©: ${data.task_id}`, 'success');
                
                // Polling du statut
                const pollStatus = async () => {
                    try {
                        const statusRes = await fetch(`${API_BASE_URL}/api/scrape/tournaments/status`);
                        if (statusRes.ok) {
                            const status = await statusRes.json();
                            
                            statusDiv.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h3 style="font-size: 1.1rem;">üèÜ Scraping des tournois</h3>
                                    <span style="background: ${status.running ? 'var(--warning)' : status.status === 'success' ? 'var(--success)' : 'var(--error)'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem;">
                                        ${status.running ? '‚è≥ En cours' : status.status === 'success' ? '‚úÖ Termin√©' : '‚ùå Erreur'}
                                    </span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                    <div>
                                        <div style="font-size: 1.5rem; font-weight: bold;">${status.completed_tournaments || 0}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">/ ${status.total_tournaments || '?'} tournois</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.5rem; font-weight: bold;">${status.total_series || 0}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">s√©ries</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.5rem; font-weight: bold;">${status.total_inscriptions || 0}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">inscriptions</div>
                                    </div>
                                </div>
                                ${status.current_tournament ? `<div style="color: var(--text-muted); font-size: 0.85rem;">En cours: ${status.current_tournament}</div>` : ''}
                                <div style="background: var(--bg-secondary); border-radius: 8px; height: 8px; margin-top: 1rem; overflow: hidden;">
                                    <div style="background: var(--accent-primary); height: 100%; width: ${status.progress_percent || 0}%; transition: width 0.3s;"></div>
                                </div>
                            `;
                            
                            if (status.running) {
                                setTimeout(pollStatus, 3000);
                            } else {
                                btn.disabled = false;
                                btn.textContent = 'üîÑ Scraper les tournois';
                                
                                // Recharger les tournois
                                await loadTournaments();
                                renderTournaments();
                                updateStats();
                                
                                if (status.status === 'success') {
                                    showToast(`‚úÖ Scraping termin√©: ${status.total_tournaments} tournois`, 'success');
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Erreur polling:', e);
                    }
                };
                
                setTimeout(pollStatus, 2000);
                
            } catch (e) {
                btn.disabled = false;
                btn.textContent = 'üîÑ Scraper les tournois';
                showToast(`‚ùå Erreur: ${e.message}`, 'error');
                statusDiv.innerHTML = `<p style="color: var(--error);">Erreur: ${e.message}</p>`;
            }
        }
        
        // Rescraper un seul tournoi
        async function rescrapeTournament() {
            if (!state.selectedTournament) {
                showToast('‚ùå Aucun tournoi s√©lectionn√©', 'error');
                return;
            }
            
            const t_id = state.selectedTournament;
            const btn = document.getElementById('rescrape-tournament-btn');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Scraping...';
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/tournaments/${t_id}/scrape`, {
                    method: 'POST'
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Erreur lors du scraping');
                }
                
                const data = await res.json();
                showToast(`‚úÖ ${data.series_count} s√©ries, ${data.inscriptions_count} inscriptions, ${data.results_count} r√©sultats`, 'success');
                
                // Recharger les d√©tails du tournoi
                await showTournamentDetail(t_id);
                
            } catch (e) {
                showToast(`‚ùå Erreur: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Rescraper ce tournoi';
            }
        }
        
        // Event listeners pour les tournois
        document.getElementById('back-to-tournaments-btn').addEventListener('click', backToTournamentsList);
        document.getElementById('rescrape-tournament-btn').addEventListener('click', rescrapeTournament);
        
        document.getElementById('tournament-level-select').addEventListener('change', async (e) => {
            await loadTournaments(e.target.value, document.getElementById('tournaments-search').value);
            renderTournaments();
        });
        
        document.getElementById('tournaments-search').addEventListener('input', async (e) => {
            // Debounce
            clearTimeout(window.tournamentsSearchTimeout);
            window.tournamentsSearchTimeout = setTimeout(async () => {
                await loadTournaments(document.getElementById('tournament-level-select').value, e.target.value);
                renderTournaments();
            }, 300);
        });
        
        // Charger les tournois quand on va sur la section
        const originalNavHandler = document.querySelector('.nav-btn[data-section="tournaments"]');
        if (originalNavHandler) {
            originalNavHandler.addEventListener('click', async () => {
                if (state.tournaments.length === 0) {
                    await loadTournaments();
                    await loadTournamentLevels();
                    renderTournaments();
                }
            });
        }

        // =============================================================================
        // INTERCLUBS
        // =============================================================================

        let interclubsDivisions = [];
        let interclubsScrapeInterval = null;

        async function loadInterclubsDivisions() {
            const select = document.getElementById('interclubs-division-select');
            const categoryFilter = document.getElementById('interclubs-category-filter');
            const weekSelect = document.getElementById('interclubs-week-select');

            // Remplir les semaines 1-22
            if (weekSelect.options.length <= 1) {
                for (let w = 1; w <= 22; w++) {
                    const opt = document.createElement('option');
                    opt.value = w;
                    opt.textContent = `Semaine ${w}`;
                    weekSelect.appendChild(opt);
                }
            }

            try {
                const res = await fetch(`${API_BASE_URL}/api/interclubs/divisions`);
                if (!res.ok) return;
                const data = await res.json();
                interclubsDivisions = data.divisions || [];

                // Extraire les categories uniques
                const categories = new Set();
                interclubsDivisions.forEach(d => {
                    if (d.division_category) categories.add(d.division_category);
                });

                // Remplir le filtre categorie
                categoryFilter.innerHTML = '<option value="">Toutes</option>';
                Array.from(categories).sort().forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    opt.textContent = cat;
                    categoryFilter.appendChild(opt);
                });

                // Remplir le select des divisions
                renderDivisionSelect();

                // Listener sur le filtre categorie
                categoryFilter.onchange = () => renderDivisionSelect();

            } catch (e) {
                console.error('Erreur chargement divisions interclubs:', e);
            }
        }

        function renderDivisionSelect() {
            const select = document.getElementById('interclubs-division-select');
            const categoryFilter = document.getElementById('interclubs-category-filter');
            const selectedCategory = categoryFilter.value;

            const currentVal = select.value;
            select.innerHTML = '<option value="">-- Choisir une division --</option>';

            let filtered = interclubsDivisions;
            if (selectedCategory) {
                filtered = filtered.filter(d => d.division_category === selectedCategory);
            }

            filtered.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.division_index;
                opt.textContent = d.division_name;
                select.appendChild(opt);
            });

            // Restaurer la selection si possible
            if (currentVal) select.value = currentVal;
        }

        async function loadInterclubsRanking() {
            const divIndex = document.getElementById('interclubs-division-select').value;
            const week = document.getElementById('interclubs-week-select').value;
            const container = document.getElementById('interclubs-ranking-content');
            const titleBar = document.getElementById('interclubs-ranking-title');
            const titleText = document.getElementById('interclubs-ranking-title-text');

            if (!divIndex || !week) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Selectionnez une division et une semaine</p>';
                titleBar.style.display = 'none';
                return;
            }

            container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Chargement...</p>';

            try {
                const res = await fetch(`${API_BASE_URL}/api/interclubs/rankings?division_index=${divIndex}&week=${week}`);
                if (!res.ok) throw new Error('Erreur API');
                const data = await res.json();

                // Trouver le nom de la division
                const div = interclubsDivisions.find(d => d.division_index == divIndex);
                const divName = div ? div.division_name : `Division ${divIndex}`;

                titleText.textContent = `${divName} - Semaine ${week}`;
                titleBar.style.display = 'block';

                if (!data.rankings || data.rankings.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">Aucun classement disponible pour cette combinaison</p>';
                    return;
                }

                let html = `<div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="padding: 0.75rem 1rem; text-align: center; color: var(--text-muted); font-weight: 600; width: 50px;">#</th>
                                <th style="padding: 0.75rem 1rem; text-align: left; color: var(--text-muted); font-weight: 600;">Equipe</th>
                                <th style="padding: 0.75rem 1rem; text-align: center; color: var(--text-muted); font-weight: 600;">J</th>
                                <th style="padding: 0.75rem 1rem; text-align: center; color: var(--text-muted); font-weight: 600;">G</th>
                                <th style="padding: 0.75rem 1rem; text-align: center; color: var(--text-muted); font-weight: 600;">P</th>
                                <th style="padding: 0.75rem 1rem; text-align: center; color: var(--text-muted); font-weight: 600;">N</th>
                                <th style="padding: 0.75rem 1rem; text-align: center; color: var(--text-muted); font-weight: 600;">FF</th>
                                <th style="padding: 0.75rem 1rem; text-align: center; color: var(--accent-primary); font-weight: 700;">Pts</th>
                            </tr>
                        </thead>
                        <tbody>`;

                data.rankings.forEach((r, i) => {
                    const isFirst = i === 0;
                    const bgStyle = isFirst ? 'background: rgba(99, 102, 241, 0.1);' : (i % 2 === 0 ? '' : 'background: var(--bg-hover);');
                    const rankColor = isFirst ? 'color: var(--warning); font-weight: 700;' : '';
                    html += `<tr style="${bgStyle} border-bottom: 1px solid var(--border); cursor: pointer;" onclick="showTeamHistory('${r.team_name.replace(/'/g, "\\'")}', ${divIndex})">
                        <td style="padding: 0.75rem 1rem; text-align: center; ${rankColor}">${r.rank || '-'}</td>
                        <td style="padding: 0.75rem 1rem; font-weight: 500;">${r.team_name}</td>
                        <td style="padding: 0.75rem 1rem; text-align: center;">${r.played}</td>
                        <td style="padding: 0.75rem 1rem; text-align: center; color: var(--success);">${r.wins}</td>
                        <td style="padding: 0.75rem 1rem; text-align: center; color: var(--error);">${r.losses}</td>
                        <td style="padding: 0.75rem 1rem; text-align: center;">${r.draws}</td>
                        <td style="padding: 0.75rem 1rem; text-align: center; color: var(--text-muted);">${r.forfeits}</td>
                        <td style="padding: 0.75rem 1rem; text-align: center; font-weight: 700; font-size: 1rem;">${r.points}</td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
                container.innerHTML = html;

            } catch (e) {
                container.innerHTML = `<p style="color: var(--error); text-align: center;">Erreur: ${e.message}</p>`;
            }
        }

        async function showTeamHistory(teamName, divisionIndex) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/interclubs/team/${encodeURIComponent(teamName)}/history?division_index=${divisionIndex}`);
                if (!res.ok) throw new Error('Erreur API');
                const data = await res.json();

                let html = `<div style="margin-bottom: 1rem;">
                    <span style="color: var(--text-muted);">Progression semaine par semaine</span>
                </div>`;

                if (data.history && data.history.length > 0) {
                    html += `<table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="padding: 0.5rem; text-align: center; color: var(--text-muted);">Sem.</th>
                                <th style="padding: 0.5rem; text-align: center; color: var(--text-muted);">#</th>
                                <th style="padding: 0.5rem; text-align: center; color: var(--text-muted);">J</th>
                                <th style="padding: 0.5rem; text-align: center; color: var(--text-muted);">G</th>
                                <th style="padding: 0.5rem; text-align: center; color: var(--text-muted);">P</th>
                                <th style="padding: 0.5rem; text-align: center; color: var(--text-muted);">N</th>
                                <th style="padding: 0.5rem; text-align: center; color: var(--accent-primary); font-weight: 700;">Pts</th>
                            </tr>
                        </thead><tbody>`;

                    data.history.forEach((h, i) => {
                        const bg = i % 2 === 0 ? '' : 'background: var(--bg-hover);';
                        html += `<tr style="${bg} border-bottom: 1px solid var(--border);">
                            <td style="padding: 0.5rem; text-align: center; font-weight: 600;">${h.week}</td>
                            <td style="padding: 0.5rem; text-align: center;">${h.rank || '-'}</td>
                            <td style="padding: 0.5rem; text-align: center;">${h.played}</td>
                            <td style="padding: 0.5rem; text-align: center; color: var(--success);">${h.wins}</td>
                            <td style="padding: 0.5rem; text-align: center; color: var(--error);">${h.losses}</td>
                            <td style="padding: 0.5rem; text-align: center;">${h.draws}</td>
                            <td style="padding: 0.5rem; text-align: center; font-weight: 700;">${h.points}</td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                } else {
                    html += '<p style="color: var(--text-muted);">Aucun historique disponible</p>';
                }

                openDetail(`üèÖ ${teamName}`, html);
            } catch (e) {
                openDetail(`üèÖ ${teamName}`, `<p style="color: var(--error);">Erreur: ${e.message}</p>`);
            }
        }

        // Recherche equipes interclubs
        document.getElementById('interclubs-team-search').addEventListener('input', async function() {
            const query = this.value.trim();
            const resultsDiv = document.getElementById('interclubs-search-results');
            const grid = document.getElementById('interclubs-search-grid');

            if (query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/api/interclubs/search?q=${encodeURIComponent(query)}&limit=30`);
                if (!res.ok) return;
                const data = await res.json();

                if (!data.teams || data.teams.length === 0) {
                    grid.innerHTML = '<p style="color: var(--text-muted);">Aucun resultat</p>';
                    resultsDiv.style.display = 'block';
                    return;
                }

                grid.innerHTML = data.teams.map(t => `
                    <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 1rem; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.borderColor='var(--accent-primary)'"
                         onmouseout="this.style.borderColor='var(--border)'"
                         onclick="showTeamHistory('${t.team_name.replace(/'/g, "\\'")}', ${t.division_index})">
                        <div style="font-weight: 600; margin-bottom: 0.3rem;">${t.team_name}</div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">${t.division_name}</div>
                    </div>
                `).join('');

                resultsDiv.style.display = 'block';
            } catch (e) {
                console.error('Erreur recherche interclubs:', e);
            }
        });

        // Scraping interclubs
        async function scrapeInterclubs() {
            const btn = document.getElementById('scrape-interclubs-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Lancement...';

            try {
                const res = await fetch(`${API_BASE_URL}/api/scrape/interclubs`, { method: 'POST' });
                if (!res.ok) {
                    const err = await res.json();
                    alert(err.detail?.error || 'Erreur lors du lancement');
                    btn.disabled = false;
                    btn.textContent = 'üîÑ Scraper les interclubs';
                    return;
                }

                btn.textContent = 'üîÑ Scraping en cours...';
                startInterclubsScrapePolling();

            } catch (e) {
                alert('Erreur: ' + e.message);
                btn.disabled = false;
                btn.textContent = 'üîÑ Scraper les interclubs';
            }
        }

        async function cancelInterclubsScrape() {
            try {
                await fetch(`${API_BASE_URL}/api/scrape/interclubs/cancel`, { method: 'POST' });
                stopInterclubsScrapePolling();
            } catch (e) {
                console.error('Erreur annulation:', e);
            }
        }

        function startInterclubsScrapePolling() {
            document.getElementById('interclubs-scrape-status').style.display = 'block';
            interclubsScrapeInterval = setInterval(checkInterclubsScrapeStatus, 3000);
        }

        function stopInterclubsScrapePolling() {
            if (interclubsScrapeInterval) {
                clearInterval(interclubsScrapeInterval);
                interclubsScrapeInterval = null;
            }
        }

        async function checkInterclubsScrapeStatus() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/scrape/interclubs/status`);
                if (!res.ok) return;
                const data = await res.json();

                const statusDiv = document.getElementById('interclubs-scrape-status');
                const infoDiv = document.getElementById('interclubs-scrape-info');
                const btn = document.getElementById('scrape-interclubs-btn');

                if (data.running) {
                    statusDiv.style.display = 'block';
                    const elapsed = data.elapsed_seconds ? Math.round(data.elapsed_seconds) : 0;
                    const mins = Math.floor(elapsed / 60);
                    const secs = elapsed % 60;
                    infoDiv.innerHTML = `
                        <div>Classements trouves: <strong>${(data.total_rankings || 0).toLocaleString()}</strong></div>
                        <div>Erreurs: ${data.errors_count || 0}</div>
                        <div>Temps ecoule: ${mins}m ${secs}s</div>
                    `;
                    btn.disabled = true;
                    btn.textContent = 'üîÑ Scraping en cours...';

                    if (!interclubsScrapeInterval) startInterclubsScrapePolling();
                } else {
                    if (data.status === 'success' || data.status === 'failed' || data.status === 'cancelled') {
                        statusDiv.style.display = 'block';
                        const icon = data.status === 'success' ? '‚úÖ' : (data.status === 'cancelled' ? '‚ö†Ô∏è' : '‚ùå');
                        infoDiv.innerHTML = `<div>${icon} ${data.status} - ${(data.total_rankings || 0).toLocaleString()} classements, ${data.errors_count || 0} erreurs</div>`;
                        stopInterclubsScrapePolling();

                        // Recharger les divisions
                        loadInterclubsDivisions();
                        updateStats();
                    } else {
                        statusDiv.style.display = 'none';
                    }

                    btn.disabled = false;
                    btn.textContent = 'üîÑ Scraper les interclubs';
                }
            } catch (e) {
                // Silently ignore
            }
        }

        // Initial render
        renderRegions();
        renderPlayers();

        // Try to load from API (cela mettra √† jour les stats)
        loadFromAPI();

        // Charger l'admin si on est sur la section admin
        if (state.currentSection === 'admin') {
            loadScrapeStatus();
            loadScrapeHistory();
        }
    </script>
</body>
</html>
